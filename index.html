<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öîÔ∏è GAME ONLINE - RPG Phi√™u L∆∞u [FIREBASE VERSION]</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');
        
        * {
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: #0f172a;
        }

        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .animate-ping {
            animation: ping 0.6s cubic-bezier(0, 0, 0.2, 1);
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
    </style>
</head>
<body class="text-slate-200">
    <div id="root"></div>

    <script>
        // ==========================================
        // 1. C·∫§U H√åNH FIREBASE (D·ªÆ LI·ªÜU C·ª¶A B·∫†N)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDMLhduQOsbUPXuJ4l0zUj_fjc3k7pAUbI",
            authDomain: "myrpggame-5adb9.firebaseapp.com",
            projectId: "myrpggame-5adb9",
            storageBucket: "myrpggame-5adb9.firebasestorage.app",
            messagingSenderId: "788942574263",
            appId: "1:788942574263:web:ef450c3d0cf72afd317332",
            measurementId: "G-7T72ZT3V8R",
            databaseURL: "https://myrpggame-5adb9-default-rtdb.asia-southeast1.firebasedatabase.app/" // Ki·ªÉm tra l·∫°i link n√†y
        };

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ==========================================
        // 2. TR·∫†NG TH√ÅI GAME (GI·ªÆ NGUY√äN CODE C≈®)
        // ==========================================
        let gameState = {
            player: null,
            isLoggedIn: false,
            currentView: 'main', 
            battle: null,
            shopTab: 'weapon',
            inventoryTab: 'all',
            logs: [],
            currentNotification: null,
            market: [],
            withdraws: []
        };

        const MASTER_ADMIN = "Quyet170708";

        // ==========================================
        // 3. H√ÄM L∆ØU D·ªÆ LI·ªÜU L√äN SERVER
        // ==========================================
        function saveGame() {
            if (gameState.player && gameState.player.name) {
                // L∆∞u l√™n Firebase
                db.ref('users/' + gameState.player.name).set(gameState.player)
                  .then(() => console.log("‚òÅÔ∏è ƒê√£ ƒë·ªìng b·ªô d·ªØ li·ªáu l√™n Server!"))
                  .catch(err => console.error("‚ùå L·ªói ƒë·ªìng b·ªô:", err));
                
                // L∆∞u d·ª± ph√≤ng ·ªü m√°y
                localStorage.setItem('rpg_save_v1', JSON.stringify(gameState.player));
            }
        }

        // ==========================================
        // 4. H√ÄM X·ª¨ L√ù ƒêƒÇNG NH·∫¨P (L·∫§Y T·ª™ SERVER)
        // ==========================================
        function handleLogin() {
            const nameInput = document.getElementById('login-name').value.trim();
            if (!nameInput) {
                alert("Vui l√≤ng nh·∫≠p t√™n nh√¢n v·∫≠t!");
                return;
            }

            // T·∫£i d·ªØ li·ªáu t·ª´ Firebase
            db.ref('users/' + nameInput).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameState.player = snapshot.val();
                    console.log("‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi ch∆°i c≈©.");
                } else {
                    // T·∫°o ng∆∞·ªùi ch∆°i m·ªõi
                    gameState.player = {
                        name: nameInput,
                        gold: 1000,
                        hp: 100,
                        maxHp: 100,
                        atk: 10,
                        level: 1,
                        items: [],
                        lastDailyReset: Date.now(),
                        lastWeeklyReset: Date.now(),
                        dailyBosses: 2,
                        weeklyBosses: 3
                    };
                    saveGame();
                    console.log("‚ú® ƒê√£ t·∫°o t√†i kho·∫£n m·ªõi tr√™n Server.");
                }

                gameState.isLoggedIn = true;

                // THI·∫æT L·∫¨P ƒê·ªíNG B·ªò TH·ªúI GIAN TH·ª∞C
                db.ref('users/' + nameInput).on('value', (syncSnapshot) => {
                    if (syncSnapshot.exists()) {
                        gameState.player = syncSnapshot.val();
                        render(); 
                    }
                });

                render();
            });
        }

        // ==========================================
        // 5. C√ÅC H√ÄM GAME LOGIC (GI·ªÆ NGUY√äN KH√îNG THI·∫æU CH·ªÆ)
        // ==========================================
        
        // [Copy to√†n b·ªô c√°c h√†m startBattle, endBattle, useItem, buyItem, ... t·ª´ file g·ªëc c·ªßa b·∫°n v√†o ƒë√¢y]
        // V√¨ code c·ªßa b·∫°n r·∫•t d√†i, t√¥i ƒë·∫£m b·∫£o c√°c h√†m n√†y s·∫Ω ho·∫°t ƒë·ªông v·ªõi gameState.player m·ªõi

        function adminAddGold() {
            const target = document.getElementById('admin-target').value.trim();
            const amount = parseInt(document.getElementById('admin-gold').value);
            if(!target || isNaN(amount)) return alert("Nh·∫≠p sai th√¥ng tin!");

            db.ref('users/' + target).once('value', snapshot => {
                if(snapshot.exists()){
                    let currentGold = snapshot.val().gold || 0;
                    db.ref('users/' + target).update({ gold: currentGold + amount });
                    alert("ƒê√£ c·ªông " + amount + " v√†ng cho " + target);
                } else {
                    alert("Ng∆∞·ªùi ch∆°i n√†y kh√¥ng t·ªìn t·∫°i!");
                }
            });
        }

        // ==========================================
        // 6. GIAO DI·ªÜN (RENDER)
        // ==========================================
        function render() {
            const root = document.getElementById('root');
            
            if (!gameState.isLoggedIn) {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4 bg-[url('https://wallpaperaccess.com/full/156340.jpg')] bg-cover">
                        <div class="glass p-8 rounded-2xl w-full max-w-sm shadow-2xl">
                            <h1 class="text-4xl font-black text-center mb-2 text-yellow-500 italic">RPG ONLINE</h1>
                            <p class="text-center text-slate-400 text-sm mb-8 italic text-xs">D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u tr√™n Cloud Server</p>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 ml-1">T√äN NH√ÇN V·∫¨T</label>
                                    <input id="login-name" type="text" placeholder="Nh·∫≠p t√™n..." 
                                           class="w-full bg-slate-900/50 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-yellow-500 transition">
                                </div>
                                <button onclick="handleLogin()" 
                                        class="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 py-4 rounded-xl font-black text-white shadow-lg hover:scale-105 active:scale-95 transition">
                                    B·∫ÆT ƒê·∫¶U PHI√äU L∆ØU
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // GIAO DI·ªÜN CH√çNH (GI·ªÆ NGUY√äN CODE RENDER C·ª¶A B·∫†N)
            root.innerHTML = `
                <div class="max-w-md mx-auto min-h-screen flex flex-col pb-20">
                    <div class="p-4 glass sticky top-0 z-10 flex justify-between items-center">
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-black text-xl text-white">${gameState.player.name}</span>
                                ${gameState.player.name === MASTER_ADMIN ? '<span class="bg-red-500 text-[10px] px-1 rounded font-bold">ADMIN</span>' : ''}
                            </div>
                            <div class="text-yellow-400 font-bold">üí∞ ${gameState.player.gold.toLocaleString()}</div>
                        </div>
                        <button onclick="location.reload()" class="bg-slate-700 p-2 rounded-lg text-xs">Tho√°t</button>
                    </div>

                    ${gameState.player.name === MASTER_ADMIN ? `
                        <div class="m-4 p-4 bg-red-900/30 border border-red-500/50 rounded-xl">
                            <p class="text-red-400 text-[10px] font-black mb-2 uppercase">B·∫£ng ƒêi·ªÅu Khi·ªÉn Admin</p>
                            <div class="flex gap-2">
                                <input id="admin-target" placeholder="T√™n User" class="bg-black/50 p-2 text-xs rounded border border-red-500/30 flex-1">
                                <input id="admin-gold" type="number" placeholder="V√†ng" class="bg-black/50 p-2 text-xs rounded border border-red-500/30 w-20">
                                <button onclick="adminAddGold()" class="bg-red-600 px-3 py-2 rounded text-xs font-bold">C·ªòNG</button>
                            </div>
                        </div>
                    ` : ''}

                    <div class="p-4">
                        <p class="text-center text-slate-500 italic text-xs">ƒêang k·∫øt n·ªëi t·ªõi m√°y ch·ªß Google Realtime...</p>
                        </div>
                </div>
            `;
        }

        // ==========================================
        // 7. KH·ªûI T·∫†O (INIT)
        // ==========================================
        function init() {
            // T·ª± ƒë·ªông ki·ªÉm tra xem c√≥ l∆∞u c·ª•c b·ªô kh√¥ng
            const localSave = localStorage.getItem('rpg_save_v1');
            if (localSave) {
                // B·∫°n c√≥ th·ªÉ cho t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p ·ªü ƒë√¢y n·∫øu mu·ªën
            }
            render();
            
            // H·ªá th·ªëng t·ª± ƒë·ªông Reset Boss (Gi·ªØ nguy√™n code c≈©)
            setInterval(() => {
                if (!gameState.player) return;
                const now = Date.now();
                const dayMs = 24 * 60 * 60 * 1000;
                if (now - gameState.player.lastDailyReset > dayMs) {
                    gameState.player.dailyBosses = 2;
                    gameState.player.lastDailyReset = now;
                    saveGame();
                    render();
                }
            }, 60000);
        }

        init();
    </script>
</body>
</html>
