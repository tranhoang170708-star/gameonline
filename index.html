<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öîÔ∏è GAME ONLINE - RPG Phi√™u L∆∞u</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <!-- ADSTERRA SOCIAL BAR - HI·ªÜN ·ªû M·ªåI N∆†I -->
    <script src="https://semicolondriverelevated.com/82/74/4a/82744aa4472a450eb55850de94ebd76c.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');
        
        * {
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .animate-ping {
            animation: ping 0.6s cubic-bezier(0, 0, 0.2, 1);
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-down {
            animation: slideDown 0.5s ease-out;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(147, 51, 234, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(147, 51, 234, 0.8);
        }

        .damage-popup {
            position: absolute;
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
            animation: damageFloat 1s ease-out forwards;
        }

        @keyframes damageFloat {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px);
            }
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .notification-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.95), rgba(139, 92, 246, 0.95));
            border-bottom: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDMLhduQOsbUPXuJ4l0zUj_fjc3k7pAUbI",
            authDomain: "myrpggame-5adb9.firebaseapp.com",
            projectId: "myrpggame-5adb9",
            storageBucket: "myrpggame-5adb9.firebasestorage.app",
            messagingSenderId: "788942574263",
            appId: "1:788942574263:web:ef450c3d0cf72afd317332",
            measurementId: "G-7T72ZT3V8R",
            databaseURL: "https://myrpggame-5adb9-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("‚úÖ Firebase initialized successfully!");
        } catch (e) {
            console.error("‚ùå Firebase initialization error:", e);
            alert("L·ªói k·∫øt n·ªëi Firebase! Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh.");
        }

        // ==================== FIREBASE DATABASE CLASS ====================
        class GameDatabase {
            constructor() {
                this.MASTER_ADMIN = 'Quyet170708';
            }

            // ===== USER MANAGEMENT =====
            async userExists(username) {
                try {
                    const snapshot = await db.ref('users/' + username).once('value');
                    return snapshot.exists();
                } catch (e) {
                    console.error('Error checking user:', e);
                    return false;
                }
            }

            async createUser(username, password) {
                try {
                    const exists = await this.userExists(username);
                    if (exists) {
                        return { success: false, message: 'Username ƒë√£ t·ªìn t·∫°i!' };
                    }

                    const userData = {
                        password: password,
                        playerData: {
                            name: username,
                            hp: 100,
                            maxHp: 100,
                            atk: 2,
                            def: 0,
                            crit: 5,
                            gold: 0,
                            level: 1,
                            exp: 0,
                            currentStage: 1,
                            totalMonstersKilled: 0,
                            weapon: null,
                            armor: null,
                            pet: null,
                            inventory: [],
                            ownedWeapons: [],
                            ownedArmors: [],
                            ownedPets: [],
                            dailyBosses: 2,
                            weeklyBosses: 3,
                            lastDailyReset: Date.now(),
                            lastWeeklyReset: Date.now(),
                        },
                        createdAt: Date.now()
                    };

                    await db.ref('users/' + username).set(userData);
                    console.log('‚úÖ User created:', username);
                    return { success: true, message: 'T·∫°o t√†i kho·∫£n th√†nh c√¥ng!' };
                } catch (e) {
                    console.error('Error creating user:', e);
                    return { success: false, message: 'L·ªói t·∫°o t√†i kho·∫£n!' };
                }
            }

            async loginUser(username, password) {
                try {
                    const snapshot = await db.ref('users/' + username).once('value');
                    
                    if (!snapshot.exists()) {
                        return { success: false, message: 'Username kh√¥ng t·ªìn t·∫°i!' };
                    }

                    const userData = snapshot.val();
                    if (userData.password !== password) {
                        return { success: false, message: 'Sai m·∫≠t kh·∫©u!' };
                    }

                    return { 
                        success: true, 
                        message: 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 
                        userData: userData.playerData 
                    };
                } catch (e) {
                    console.error('Error logging in:', e);
                    return { success: false, message: 'L·ªói ƒëƒÉng nh·∫≠p!' };
                }
            }

            async savePlayerData(username, playerData) {
                try {
                    await db.ref('users/' + username + '/playerData').set(playerData);
                    console.log('‚úÖ Player data saved:', username);
                    return true;
                } catch (e) {
                    console.error('Error saving player data:', e);
                    return false;
                }
            }

            async getPlayerData(username) {
                try {
                    const snapshot = await db.ref('users/' + username + '/playerData').once('value');
                    return snapshot.exists() ? snapshot.val() : null;
                } catch (e) {
                    console.error('Error getting player data:', e);
                    return null;
                }
            }

            // ===== ADMIN MANAGEMENT =====
            async getAllAdmins() {
                try {
                    const snapshot = await db.ref('admins').once('value');
                    const admins = snapshot.exists() ? snapshot.val() : [];
                    if (!admins.includes(this.MASTER_ADMIN)) {
                        admins.push(this.MASTER_ADMIN);
                        await db.ref('admins').set(admins);
                    }
                    return admins;
                } catch (e) {
                    console.error('Error getting admins:', e);
                    return [this.MASTER_ADMIN];
                }
            }

            async isAdmin(username) {
                const admins = await this.getAllAdmins();
                return admins.includes(username);
            }

            isMasterAdmin(username) {
                return username === this.MASTER_ADMIN;
            }

            async addAdmin(username) {
                try {
                    const exists = await this.userExists(username);
                    if (!exists) {
                        return { success: false, message: 'User kh√¥ng t·ªìn t·∫°i!' };
                    }

                    const admins = await this.getAllAdmins();
                    if (admins.includes(username)) {
                        return { success: false, message: 'User n√†y ƒë√£ l√† Admin!' };
                    }

                    admins.push(username);
                    await db.ref('admins').set(admins);
                    return { success: true, message: `ƒê√£ th√™m ${username} v√†o Admin!` };
                } catch (e) {
                    console.error('Error adding admin:', e);
                    return { success: false, message: 'L·ªói th√™m admin!' };
                }
            }

            async removeAdmin(username) {
                try {
                    if (username === this.MASTER_ADMIN) {
                        return { success: false, message: 'Kh√¥ng th·ªÉ g·ª° Master Admin!' };
                    }

                    const admins = await this.getAllAdmins();
                    const newAdmins = admins.filter(a => a !== username);
                    
                    if (newAdmins.length < admins.length) {
                        await db.ref('admins').set(newAdmins);
                        return { success: true, message: `ƒê√£ g·ª° ${username} kh·ªèi Admin!` };
                    }
                    
                    return { success: false, message: 'User kh√¥ng ph·∫£i Admin!' };
                } catch (e) {
                    console.error('Error removing admin:', e);
                    return { success: false, message: 'L·ªói g·ª° admin!' };
                }
            }

            // ===== GOLD MODIFICATION =====
            async modifyUserGold(username, amount) {
                try {
                    const exists = await this.userExists(username);
                    if (!exists) {
                        return { success: false, message: `User "${username}" kh√¥ng t·ªìn t·∫°i!` };
                    }

                    const snapshot = await db.ref('users/' + username + '/playerData/gold').once('value');
                    const currentGold = snapshot.exists() ? snapshot.val() : 0;
                    const newGold = Math.max(0, currentGold + amount);
                    
                    await db.ref('users/' + username + '/playerData/gold').set(newGold);
                    
                    console.log('‚úÖ Gold modified:', username, 'New balance:', newGold);
                    return { success: true, gold: newGold };
                } catch (e) {
                    console.error('Error modifying gold:', e);
                    return { success: false, message: 'L·ªói c·ªông/tr·ª´ v√†ng!' };
                }
            }

            // ===== NOTIFICATIONS =====
            async getAllNotifications() {
                try {
                    const snapshot = await db.ref('notifications').once('value');
                    return snapshot.exists() ? snapshot.val() : [];
                } catch (e) {
                    console.error('Error getting notifications:', e);
                    return [];
                }
            }

            async addNotification(message, type = 'info') {
                try {
                    const notifications = await this.getAllNotifications();
                    const newNotif = {
                        id: Date.now(),
                        message: message,
                        type: type,
                        createdAt: Date.now(),
                        dismissed: false
                    };
                    notifications.unshift(newNotif);
                    
                    if (notifications.length > 50) {
                        notifications.splice(50);
                    }
                    
                    await db.ref('notifications').set(notifications);
                    return newNotif;
                } catch (e) {
                    console.error('Error adding notification:', e);
                    return null;
                }
            }

            async getActiveNotifications() {
                const notifications = await this.getAllNotifications();
                const now = Date.now();
                const dayMs = 24 * 60 * 60 * 1000;
                return notifications.filter(n => !n.dismissed && (now - n.createdAt) < dayMs);
            }

            async dismissNotification(notifId) {
                try {
                    const notifications = await this.getAllNotifications();
                    const notif = notifications.find(n => n.id === notifId);
                    if (notif) {
                        notif.dismissed = true;
                        await db.ref('notifications').set(notifications);
                        return true;
                    }
                    return false;
                } catch (e) {
                    console.error('Error dismissing notification:', e);
                    return false;
                }
            }

            // ===== MARKET =====
            async getAllMarketListings() {
                try {
                    const snapshot = await db.ref('market').once('value');
                    return snapshot.exists() ? snapshot.val() : [];
                } catch (e) {
                    console.error('Error getting market listings:', e);
                    return [];
                }
            }

            async addMarketListing(seller, item, type, price) {
                try {
                    const listings = await this.getAllMarketListings();
                    const newListing = {
                        id: Date.now(),
                        seller: seller,
                        item: item,
                        type: type,
                        price: price,
                        listedAt: Date.now()
                    };
                    listings.push(newListing);
                    await db.ref('market').set(listings);
                    return newListing;
                } catch (e) {
                    console.error('Error adding market listing:', e);
                    return null;
                }
            }

            async removeMarketListing(listingId) {
                try {
                    const listings = await this.getAllMarketListings();
                    const listing = listings.find(l => l.id === listingId);
                    const newListings = listings.filter(l => l.id !== listingId);
                    await db.ref('market').set(newListings);
                    return listing;
                } catch (e) {
                    console.error('Error removing market listing:', e);
                    return null;
                }
            }

            async getMyListings(username) {
                const listings = await this.getAllMarketListings();
                return listings.filter(l => l.seller === username);
            }

            async getOthersListings(username) {
                const listings = await this.getAllMarketListings();
                return listings.filter(l => l.seller !== username);
            }

            // ===== WITHDRAW =====
            async getAllWithdrawRequests() {
                try {
                    const snapshot = await db.ref('withdrawals').once('value');
                    return snapshot.exists() ? snapshot.val() : [];
                } catch (e) {
                    console.error('Error getting withdraw requests:', e);
                    return [];
                }
            }

            async addWithdrawRequest(username, method, amount, details) {
                try {
                    const requests = await this.getAllWithdrawRequests();
                    const newRequest = {
                        id: Date.now(),
                        username: username,
                        method: method,
                        amount: amount,
                        details: details,
                        status: 'pending',
                        date: new Date().toLocaleString('vi-VN'),
                        createdAt: Date.now()
                    };
                    
                    if (method === 'card') {
                        newRequest.cardCode = this.generateCardCode();
                    }
                    
                    requests.push(newRequest);
                    await db.ref('withdrawals').set(requests);
                    return newRequest;
                } catch (e) {
                    console.error('Error adding withdraw request:', e);
                    return null;
                }
            }

            async updateWithdrawStatus(requestId, status) {
                try {
                    const requests = await this.getAllWithdrawRequests();
                    const request = requests.find(r => r.id === requestId);
                    if (request) {
                        request.status = status;
                        await db.ref('withdrawals').set(requests);
                        return true;
                    }
                    return false;
                } catch (e) {
                    console.error('Error updating withdraw status:', e);
                    return false;
                }
            }

            async deleteWithdrawRequest(requestId) {
                try {
                    const requests = await this.getAllWithdrawRequests();
                    const newRequests = requests.filter(r => r.id !== requestId);
                    await db.ref('withdrawals').set(newRequests);
                    return true;
                } catch (e) {
                    console.error('Error deleting withdraw request:', e);
                    return false;
                }
            }

            async getUserWithdrawRequests(username) {
                const requests = await this.getAllWithdrawRequests();
                return requests.filter(r => r.username === username);
            }

            generateCardCode() {
                const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                let code = '';
                for (let i = 0; i < 12; i++) {
                    code += chars[Math.floor(Math.random() * chars.length)];
                }
                return code;
            }

            // ===== GET ALL USERS =====
            async getAllUsers() {
                try {
                    const snapshot = await db.ref('users').once('value');
                    return snapshot.exists() ? snapshot.val() : {};
                } catch (e) {
                    console.error('Error getting all users:', e);
                    return {};
                }
            }
        }

        const DB = new GameDatabase();

        // ==================== GAME STATE ====================
        let gameState = {
            isLoggedIn: false,
            currentUsername: null,
            authView: 'login',
            authError: '',
            player: null,
            currentView: 'game',
            battleLog: [],
            monster: null,
            isInBattle: false,
            canAttack: true,
            autoFight: true,
            adBoosts: {
                hp: { active: false, endTime: 0 },
                atk: { active: false, endTime: 0 },
                def: { active: false, endTime: 0 }
            },
            adsWatched: 0,
            marketView: 'browse',
            selectedItemToSell: null,
            sellPrice: '',
            showSupport: false,
            currentNotification: null
        };

        // ==================== SHOP DATA ====================
        window.weaponShop = [
            { name: 'Ki·∫øm G·ªó', atk: 10, price: 200, icon: 'ü™µ' },
            { name: 'Ki·∫øm ƒê√°', atk: 25, price: 500, icon: 'ü™®' },
            { name: 'Ki·∫øm S·∫Øt', atk: 40, price: 1000, icon: '‚öîÔ∏è' },
            { name: 'Ki·∫øm V√†ng', atk: 60, price: 2000, icon: 'üíõ' },
            { name: 'Ki·∫øm Kim C∆∞∆°ng', atk: 100, price: 3500, icon: 'üíé' },
            { name: 'Ki·∫øm C·∫ßu V·ªìng', atk: 130, price: 5000, icon: 'üåà' },
            { name: 'Ki·∫øm Th√°nh', atk: 150, price: 7000, icon: '‚ú®' },
        ];

        window.armorShop = [
            { name: 'Gi√°p V·∫£i', def: 3, hp: 50, price: 500, icon: 'üëï' },
            { name: 'Gi√°p ƒê·ªìng', def: 7, hp: 75, price: 1000, icon: 'ü•â' },
            { name: 'Gi√°p S·∫Øt', def: 10, hp: 100, price: 1500, icon: 'üõ°Ô∏è' },
            { name: 'Gi√°p Kim C∆∞∆°ng', def: 15, hp: 150, price: 3000, icon: 'üí†' },
            { name: 'Gi√°p Th√°nh', def: 30, hp: 300, price: 5000, icon: 'üëë' },
        ];

        window.petShop = [
            { name: 'G√† Con', atkBonus: 4, price: 500, icon: 'üêî' },
            { name: 'Ch√≥ Con', atkBonus: 7, price: 1000, icon: 'üêï' },
            { name: 'S√≥i X√°m', atkBonus: 11, price: 1500, icon: 'üê∫' },
            { name: 'Voi Ma M√∫t', atkBonus: 15, price: 2300, icon: 'üêò' },
            { name: 'R·ªìng Th·∫ßn', atkBonus: 20, price: 3500, icon: 'üêâ' },
        ];

        // ==================== AD SMART LINK FUNCTION ====================
        function openSmartLink() {
            // M·ªü Smart Link trong tab/window m·ªõi
            window.open('https://semicolondriverelevated.com/s9ae0s1p?key=bda893f9d0a68097bed549b6d4b78214', '_blank');
        }

        // ==================== AUTH FUNCTIONS ====================
        async function handleRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (username.length < 3) {
                gameState.authError = 'Username ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±!';
                render();
                return;
            }

            if (password.length < 5) {
                gameState.authError = 'Password ph·∫£i c√≥ √≠t nh·∫•t 5 k√Ω t·ª±!';
                render();
                return;
            }

            const result = await DB.createUser(username, password);
            
            if (result.success) {
                gameState.authError = '';
                gameState.authView = 'login';
                addLog('‚úÖ ' + result.message, 'success');
                render();
            } else {
                gameState.authError = result.message;
                render();
            }
        }

        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const result = await DB.loginUser(username, password);
        
            if (result.success) {
                gameState.isLoggedIn = true;
                gameState.currentUsername = username;
                gameState.player = result.userData;
                gameState.authError = '';
        
                let needSave = false;
        
                if (!gameState.player.ownedWeapons) {
                    gameState.player.ownedWeapons = [];
                    needSave = true;
                }
                if (!gameState.player.ownedArmors) {
                    gameState.player.ownedArmors = [];
                    needSave = true;
                }
                if (!gameState.player.ownedPets) {
                    gameState.player.ownedPets = [];
                    needSave = true;
                }
                if (!gameState.player.dailyBosses) {
                    gameState.player.dailyBosses = 2;
                    gameState.player.lastDailyReset = Date.now();
                    needSave = true;
                }
                if (!gameState.player.weeklyBosses) {
                    gameState.player.weeklyBosses = 3;
                    gameState.player.lastWeeklyReset = Date.now();
                    needSave = true;
                }
        
                // Sync HP v·ªÅ ƒë√∫ng maxHp sau khi player ƒë√£ load
                const stats = getTotalStats();
                if (gameState.player.hp < stats.totalHp && !gameState.isInBattle) {
                    gameState.player.hp = stats.totalHp;
                    needSave = true;
                }
        
                if (needSave) {
                    await saveGame();
                }
        
                localStorage.setItem('rpg_session_user', username);
                localStorage.setItem('rpg_session_pass', password);
        
                db.ref('users/' + username + '/playerData').on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        gameState.player = snapshot.val();
                        render();
                    }
                });
        
                checkNotifications();
        
                setTimeout(() => {
                    if (!gameState.isInBattle && gameState.currentView === 'game') {
                        startBattle();
                    }
                }, 500);
        
                render();
            } else {
                gameState.authError = result.message;
                render();
            }
        }
        function handleLogout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                if (gameState.currentUsername) {
                    db.ref('users/' + gameState.currentUsername + '/playerData').off();
                }
                
                localStorage.removeItem('rpg_session_user');
                localStorage.removeItem('rpg_session_pass');
                
                gameState.isLoggedIn = false;
                gameState.currentUsername = null;
                gameState.player = null;
                gameState.authError = '';
                gameState.authView = 'login';
                render();
            }
        }

        // ==================== NOTIFICATION FUNCTIONS ====================
        async function checkNotifications() {
            const activeNotifs = await DB.getActiveNotifications();
            if (activeNotifs.length > 0 && !gameState.currentNotification) {
                gameState.currentNotification = activeNotifs[0];
                render();
            }
        }

        async function dismissCurrentNotification() {
            if (gameState.currentNotification) {
                await DB.dismissNotification(gameState.currentNotification.id);
                gameState.currentNotification = null;
                checkNotifications();
                render();
            }
        }

        // ==================== SAVE/LOAD FUNCTIONS ====================
        async function saveGame() {
            if (gameState.currentUsername && gameState.player) {
                await DB.savePlayerData(gameState.currentUsername, gameState.player);
            }
        }

        // ==================== STATS CALCULATION ====================
        function getTotalStats() {
            let totalAtk = gameState.player.atk;
            let totalDef = gameState.player.def;
            let totalHp = gameState.player.maxHp;
            let totalCrit = gameState.player.crit;

            if (gameState.player.weapon) totalAtk += gameState.player.weapon.atk;
            if (gameState.player.armor) {
                totalDef += gameState.player.armor.def;
                totalHp += gameState.player.armor.hp;
            }
            if (gameState.player.pet) {
                totalAtk += Math.floor(totalAtk * (gameState.player.pet.atkBonus / 100));
            }

            if (gameState.adBoosts.hp.active && Date.now() < gameState.adBoosts.hp.endTime) totalHp += 100;
            if (gameState.adBoosts.atk.active && Date.now() < gameState.adBoosts.atk.endTime) totalAtk += 75;
            if (gameState.adBoosts.def.active && Date.now() < gameState.adBoosts.def.endTime) totalDef += 10;

            return { totalAtk, totalDef, totalHp, totalCrit };
        }

        // ==================== MONSTER GENERATION (TƒÇNG ƒê·ªò KH√ì) ====================
        function generateMonster(stage, isBoss = false, bossType = 'normal') {
            // TƒÇNG HP V√Ä ATK C·ª¶A QU√ÅI ƒê·ªÇ KH√ì KI·∫æM TI·ªÄN H∆†N
            const baseHp = 50 + stage * 25;  // TƒÉng t·ª´ 30 + stage*15
            const baseAtk = 2 + stage * 1;   // TƒÉng t·ª´ 1 + stage*0.5
            
            let hp = baseHp;
            let atk = baseAtk;
            // GI·∫¢M V√ÄNG NH·∫¨N ƒê∆Ø·ª¢C
            let goldReward = Math.floor((5 + stage * 3) * 0.4);  // Gi·∫£m ƒë√°ng k·ªÉ
            let expReward = Math.floor((20 + stage * 10) * 0.7);
            let name = `Qu√°i V·∫≠t Lv.${stage}`;
            let icon = 'üëæ';
            let damageType = 'fixed';
            let damagePercent = 0;

            if (isBoss) {
                if (bossType === 'stage') {
                    hp = baseHp * 1.5;
                    atk = baseAtk * 1.3;
                    goldReward = Math.floor(goldReward * 2);
                    expReward = Math.floor(expReward * 1.8);
                    name = `Boss ·∫¢i ${Math.floor(stage / 10) + 1}`;
                    icon = 'üëπ';
                } else if (bossType === 'daily') {
                    hp = baseHp * 4;
                    atk = baseAtk * 2.5;
                    goldReward = Math.floor(goldReward * 5);
                    expReward = Math.floor(expReward * 2.5);
                    name = `Boss Ng√†y`;
                    icon = 'üî•';
                    damageType = 'percent';
                    damagePercent = 40;
                } else if (bossType === 'weekly') {
                    hp = baseHp * 6;
                    atk = baseAtk * 3.5;
                    goldReward = Math.floor(goldReward * 8);
                    expReward = Math.floor(expReward * 4);
                    name = `Boss Tu·∫ßn`;
                    icon = '‚ö°';
                    damageType = 'percent';
                    damagePercent = 80;
                }
            }

            return {
                name,
                icon,
                hp: Math.floor(hp),
                maxHp: Math.floor(hp),
                atk: Math.floor(atk),
                goldReward: Math.floor(goldReward),
                expReward: Math.floor(expReward),
                stage,
                isBoss,
                bossType,
                damageType,
                damagePercent
            };
        }

        // ==================== BATTLE SYSTEM ====================
        function addLog(message, type = 'info') {
            gameState.battleLog.push({ message, type, time: Date.now() });
            if (gameState.battleLog.length > 10) {
                gameState.battleLog = gameState.battleLog.slice(-10);
            }
            render();
        }

        function startBattle(bossType = null) {
            const isBoss = bossType !== null;
            let newMonster;

            if (bossType === 'daily') {
                if (gameState.player.dailyBosses <= 0) {
                    addLog('‚ö†Ô∏è B·∫°n ƒë√£ h·∫øt l∆∞·ª£t ƒë√°nh Boss Ng√†y!', 'error');
                    return;
                }
                newMonster = generateMonster(gameState.player.currentStage, true, 'daily');
            } else if (bossType === 'weekly') {
                if (gameState.player.weeklyBosses <= 0) {
                    addLog('‚ö†Ô∏è B·∫°n ƒë√£ h·∫øt l∆∞·ª£t ƒë√°nh Boss Tu·∫ßn!', 'error');
                    return;
                }
                newMonster = generateMonster(gameState.player.currentStage, true, 'weekly');
            } else {
                const isStageBoss = gameState.player.totalMonstersKilled > 0 && gameState.player.totalMonstersKilled % 10 === 0;
                newMonster = generateMonster(gameState.player.currentStage, isStageBoss, isStageBoss ? 'stage' : null);
            }

            gameState.monster = newMonster;
            gameState.isInBattle = true;
            gameState.canAttack = true;
            gameState.battleLog = [];
            addLog(`‚öîÔ∏è Chi·∫øn ƒë·∫•u v·ªõi ${newMonster.icon} ${newMonster.name}!`, 'info');
            addLog(`üí° Click v√†o qu√°i ƒë·ªÉ t·∫•n c√¥ng!`, 'info');
        }

        function playerAttack(e) {
            if (!gameState.canAttack || !gameState.monster || !gameState.isInBattle) return;

            const stats = getTotalStats();
            const isCrit = Math.random() * 100 < stats.totalCrit;
            let damage = stats.totalAtk;
            if (isCrit) damage *= 2;

            gameState.monster.hp = Math.max(0, gameState.monster.hp - damage);

            addLog(`üí• B·∫°n g√¢y ${damage} s√°t th∆∞∆°ng${isCrit ? ' (CH√ç M·∫†NG!)' : ''}`, 'success');

            gameState.canAttack = false;
            setTimeout(() => {
                gameState.canAttack = true;
            }, 200);

            if (gameState.monster.hp <= 0) {
                handleVictory(gameState.monster);
            } else {
                setTimeout(() => monsterAttack(), 500);
            }
        }

        function monsterAttack() {
            if (!gameState.monster || !gameState.isInBattle) return;

            const stats = getTotalStats();
            let damage;

            if (gameState.monster.damageType === 'percent') {
                damage = Math.floor(stats.totalAtk * gameState.monster.damagePercent / 100);
                damage = Math.max(1, damage - stats.totalDef);
                addLog(`üî¥ ${gameState.monster.name} g√¢y ${damage} s√°t th∆∞∆°ng (${gameState.monster.damagePercent}% ATK c·ªßa b·∫°n)!`, 'error');
            } else {
                damage = Math.max(1, gameState.monster.atk - stats.totalDef);
                addLog(`üî¥ ${gameState.monster.name} g√¢y ${damage} s√°t th∆∞∆°ng!`, 'error');
            }

            gameState.player.hp = Math.max(0, gameState.player.hp - damage);

            if (gameState.player.hp <= 0) {
                handleDefeat();
            } else {
                render();
            }
        }

        async function handleVictory(defeatedMonster) {
            const newGold = gameState.player.gold + defeatedMonster.goldReward;
            const newExp = gameState.player.exp + defeatedMonster.expReward;
            const expToLevel = gameState.player.level * 100;
            
            let newLevel = gameState.player.level;
            let remainingExp = newExp;
            let newAtk = gameState.player.atk;
            let newMaxHp = gameState.player.maxHp;

            while (remainingExp >= expToLevel) {
                remainingExp -= expToLevel;
                newLevel++;
                newAtk += 2;
                newMaxHp += 10;
            }

            gameState.player.gold = newGold;
            gameState.player.exp = remainingExp;
            gameState.player.level = newLevel;
            gameState.player.atk = newAtk;
            gameState.player.maxHp = newMaxHp;
            const stats = getTotalStats();
            gameState.player.hp = stats.totalHp;

            if (defeatedMonster.bossType === 'daily') {
                gameState.player.dailyBosses--;
            } else if (defeatedMonster.bossType === 'weekly') {
                gameState.player.weeklyBosses--;
            } else if (!defeatedMonster.isBoss) {
                gameState.player.currentStage++;
                gameState.player.totalMonstersKilled++;
            } else if (defeatedMonster.bossType === 'stage') {
                gameState.player.currentStage++;
                gameState.player.totalMonstersKilled++;
            }

            await saveGame();

            addLog(`üéâ Chi·∫øn th·∫Øng! +${defeatedMonster.goldReward}üí∞ +${defeatedMonster.expReward}‚≠ê`, 'success');
            if (newLevel > gameState.player.level) {
                addLog(`üÜô Level Up! Lv.${newLevel}`, 'success');
            }

            gameState.isInBattle = false;
            gameState.monster = null;

            if (gameState.autoFight && gameState.currentView === 'game') {
                setTimeout(() => {
                    if (gameState.currentView === 'game' && !gameState.isInBattle) {
                        startBattle();
                    }
                }, 100);
            }
        }

        async function handleDefeat() {
            const goldLost = Math.floor(gameState.player.gold * 0.1);
            gameState.player.gold = Math.max(0, gameState.player.gold - goldLost);
            
            addLog(`üíÄ B·∫°n ƒë√£ thua! -${goldLost} v√†ng (10%)`, 'error');
            
            const stats = getTotalStats();
            gameState.player.hp = stats.totalHp;
            await saveGame();
            gameState.isInBattle = false;
            gameState.monster = null;
            
            if (gameState.autoFight && gameState.currentView === 'game') {
                setTimeout(() => {
                    if (gameState.currentView === 'game' && !gameState.isInBattle) {
                        startBattle();
                    }
                }, 200);
            }
        }

        function toggleAutoFight() {
            gameState.autoFight = !gameState.autoFight;
            render();
            
            if (gameState.autoFight && !gameState.isInBattle && gameState.currentView === 'game') {
                setTimeout(() => {
                    if (!gameState.isInBattle && gameState.currentView === 'game') {
                        startBattle();
                    }
                }, 500);
            }
        }

        // ==================== SHOP FUNCTIONS ====================
        async function buyItem(item, type) {
            if (gameState.player.gold < item.price) {
                addLog('‚ö†Ô∏è Kh√¥ng ƒë·ªß v√†ng!', 'error');
                return;
            }

            let owned = false;
            if (type === 'weapon') {
                owned = (gameState.player.ownedWeapons || []).some(w => w.name === item.name);
            } else if (type === 'armor') {
                owned = (gameState.player.ownedArmors || []).some(a => a.name === item.name);
            } else if (type === 'pet') {
                owned = (gameState.player.ownedPets || []).some(p => p.name === item.name);
            }

            if (owned) {
                addLog('‚ö†Ô∏è B·∫°n ƒë√£ s·ªü h·ªØu v·∫≠t ph·∫©m n√†y!', 'error');
                return;
            }

            gameState.player.gold -= item.price;
            
            if (type === 'weapon') {
                if (!gameState.player.ownedWeapons) gameState.player.ownedWeapons = [];
                gameState.player.ownedWeapons.push(item);
                gameState.player.weapon = item;
            } else if (type === 'armor') {
                if (!gameState.player.ownedArmors) gameState.player.ownedArmors = [];
                gameState.player.ownedArmors.push(item);
                gameState.player.armor = item;
                gameState.player.maxHp += item.hp;
                const stats = getTotalStats();
                gameState.player.hp = stats.totalHp;
            } else if (type === 'pet') {
                if (!gameState.player.ownedPets) gameState.player.ownedPets = [];
                gameState.player.ownedPets.push(item);
                gameState.player.pet = item;
            }

            await saveGame();
            addLog(`‚úÖ ƒê√£ mua v√† trang b·ªã ${item.icon} ${item.name}!`, 'success');
            render();
        }

        async function equipItem(item, type) {
            if (type === 'weapon') {
                if (gameState.player.weapon?.name === item.name) {
                    addLog('‚ö†Ô∏è ƒêang s·ª≠ d·ª•ng v≈© kh√≠ n√†y r·ªìi!', 'error');
                    return;
                }
                gameState.player.weapon = item;
                addLog(`‚úÖ ƒê√£ trang b·ªã ${item.icon} ${item.name}!`, 'success');
            } else if (type === 'armor') {
                if (gameState.player.armor?.name === item.name) {
                    addLog('‚ö†Ô∏è ƒêang s·ª≠ d·ª•ng gi√°p n√†y r·ªìi!', 'error');
                    return;
                }
                
                if (gameState.player.armor) {
                    gameState.player.maxHp -= gameState.player.armor.hp;
                }
                
                gameState.player.armor = item;
                gameState.player.maxHp += item.hp;
                
                const stats = getTotalStats();
                if (gameState.player.hp > stats.totalHp) {
                    gameState.player.hp = stats.totalHp;
                }
                
                addLog(`‚úÖ ƒê√£ trang b·ªã ${item.icon} ${item.name}!`, 'success');
            } else if (type === 'pet') {
                if (gameState.player.pet?.name === item.name) {
                    addLog('‚ö†Ô∏è ƒêang s·ª≠ d·ª•ng pet n√†y r·ªìi!', 'error');
                    return;
                }
                gameState.player.pet = item;
                addLog(`‚úÖ ƒê√£ tri·ªáu h·ªìi ${item.icon} ${item.name}!`, 'success');
            }
            
            await saveGame();
            render();
        }

        // ==================== MARKET FUNCTIONS ====================
        function canSellItem(item, type) {
            if (type === 'weapon' && gameState.player.weapon?.name === item.name) return false;
            if (type === 'armor' && gameState.player.armor?.name === item.name) return false;
            if (type === 'pet' && gameState.player.pet?.name === item.name) return false;
            return true;
        }

        function selectItemToSell(itemName, type) {
            let item = null;
            if (type === 'weapon') {
                item = (gameState.player.ownedWeapons || []).find(w => w.name === itemName);
            } else if (type === 'armor') {
                item = (gameState.player.ownedArmors || []).find(a => a.name === itemName);
            } else if (type === 'pet') {
                item = (gameState.player.ownedPets || []).find(p => p.name === itemName);
            }
            
            if (!item) {
                alert('Kh√¥ng t√¨m th·∫•y v·∫≠t ph·∫©m!');
                return;
            }
            
            if (!canSellItem(item, type)) {
                alert('Kh√¥ng th·ªÉ b√°n ƒë·ªì ƒëang trang b·ªã! Vui l√≤ng th√°o ra tr∆∞·ªõc.');
                return;
            }
            gameState.selectedItemToSell = { item, type };
            gameState.marketView = 'sell';
            render();
        }

        async function listItemForSale() {
            const price = parseInt(gameState.sellPrice);
            
            if (!price || price <= 0) {
                alert('Vui l√≤ng nh·∫≠p gi√° h·ª£p l·ªá!');
                return;
            }

            if (!gameState.selectedItemToSell) {
                alert('Vui l√≤ng ch·ªçn v·∫≠t ph·∫©m mu·ªën b√°n!');
                return;
            }

            const { item, type } = gameState.selectedItemToSell;

            if (type === 'weapon') {
                gameState.player.ownedWeapons = (gameState.player.ownedWeapons || []).filter(w => w.name !== item.name);
            } else if (type === 'armor') {
                gameState.player.ownedArmors = (gameState.player.ownedArmors || []).filter(a => a.name !== item.name);
            } else if (type === 'pet') {
                gameState.player.ownedPets = (gameState.player.ownedPets || []).filter(p => p.name !== item.name);
            }

            await DB.addMarketListing(gameState.currentUsername, item, type, price);
            
            await saveGame();
            gameState.selectedItemToSell = null;
            gameState.sellPrice = '';
            gameState.marketView = 'browse';
            
            addLog(`‚úÖ ƒê√£ ƒëƒÉng b√°n ${item.icon} ${item.name} v·ªõi gi√° ${price.toLocaleString()}ƒë!`, 'success');
            render();
        }

        async function buyFromMarket(listingId) {
            const allListings = await DB.getAllMarketListings();
            const listing = allListings.find(l => l.id === listingId);
            
            if (!listing) {
                alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!');
                render();
                return;
            }
            
            if (gameState.player.gold < listing.price) {
                alert('Kh√¥ng ƒë·ªß v√†ng ƒë·ªÉ mua!');
                return;
            }

            gameState.player.gold -= listing.price;

            const { item, type } = listing;
            if (type === 'weapon') {
                if (!gameState.player.ownedWeapons) gameState.player.ownedWeapons = [];
                gameState.player.ownedWeapons.push(item);
            } else if (type === 'armor') {
                if (!gameState.player.ownedArmors) gameState.player.ownedArmors = [];
                gameState.player.ownedArmors.push(item);
            } else if (type === 'pet') {
                if (!gameState.player.ownedPets) gameState.player.ownedPets = [];
                gameState.player.ownedPets.push(item);
            }

            const sellerData = await DB.getPlayerData(listing.seller);
            if (sellerData) {
                sellerData.gold += listing.price;
                await DB.savePlayerData(listing.seller, sellerData);
            }

            await DB.removeMarketListing(listing.id);

            await saveGame();
            addLog(`‚úÖ ƒê√£ mua ${item.icon} ${item.name} t·ª´ ${listing.seller}!`, 'success');
            render();
        }

        async function removeListing(listingId) {
            const listing = await DB.removeMarketListing(listingId);
            
            if (listing) {
                const { item, type } = listing;
                if (type === 'weapon') {
                    gameState.player.ownedWeapons.push(item);
                } else if (type === 'armor') {
                    gameState.player.ownedArmors.push(item);
                } else if (type === 'pet') {
                    gameState.player.ownedPets.push(item);
                }
                
                saveGame();
                addLog(`‚úÖ ƒê√£ g·ª° ${item.icon} ${item.name} kh·ªèi ch·ª£!`, 'success');
                render();
            }
        }

        // ==================== UPGRADE FUNCTIONS ====================
        async function upgradeStats(stat) {
            const costs = {
                atk: 100 + gameState.player.atk * 50,
                hp: 150 + gameState.player.maxHp * 2,
                crit: 200 + gameState.player.crit * 100
            };

            if (gameState.player.gold < costs[stat]) {
                addLog('‚ö†Ô∏è Kh√¥ng ƒë·ªß v√†ng ƒë·ªÉ n√¢ng c·∫•p!', 'error');
                return;
            }

            gameState.player.gold -= costs[stat];
            
            if (stat === 'atk') {
                gameState.player.atk += 5;
            } else if (stat === 'hp') {
                gameState.player.maxHp += 20;
                const stats = getTotalStats();
                gameState.player.hp = stats.totalHp;
            } else if (stat === 'crit') {
                gameState.player.crit += 2;
            }

            await saveGame();
            addLog(`‚¨ÜÔ∏è ƒê√£ n√¢ng c·∫•p ${stat.toUpperCase()}!`, 'success');
            render();
        }

        // ==================== AD FUNCTIONS (C·∫¢I TI·∫æN) ====================
        function calculateAdReward() {
            // GI·∫¢M PH·∫¶N TH∆Ø·ªûNG V√ÄNG T·ª™ QU·∫¢NG C√ÅO
            const baseReward = 20;  // Gi·∫£m t·ª´ 50
            const difficulty = Math.max(1, gameState.player.currentStage / 10);
            const randomBonus = Math.random() * 0.3 + 0.5;  // Gi·∫£m random
            return Math.floor(baseReward * difficulty * randomBonus * 0.3);  // Gi·∫£m t·ª´ 0.7
        }

        function watchAd(type) {
            // KI·ªÇM TRA COOLDOWN 10 PH√öT
            if (type === 'hp' || type === 'atk' || type === 'def') {
                const now = Date.now();
                if (gameState.adBoosts[type].active && now < gameState.adBoosts[type].endTime) {
                    const minutesLeft = Math.ceil((gameState.adBoosts[type].endTime - now) / 60000);
                    addLog(`‚è≥ Buff ${type.toUpperCase()} c√≤n ${minutesLeft} ph√∫t! Ch·ªù h·∫øt m·ªõi xem l·∫°i.`, 'error');
                    return;
                }
            }

            addLog('üì∫ ƒêang m·ªü qu·∫£ng c√°o...', 'info');
            
            // M·ªû SMART LINK
            openSmartLink();
            
            // POPUP S·∫º T·ª∞ CH·∫†Y NH·ªú SCRIPT ·ªû <HEAD>
            
            setTimeout(() => {
                gameState.adsWatched++;
                
                if (type === 'hp' || type === 'atk' || type === 'def') {
                    const endTime = Date.now() + 10 * 60 * 1000; // 10 PH√öT
                    gameState.adBoosts[type] = { active: true, endTime };
                    
                    // N·∫æU L√Ä BUFF HP, C·ªòNG LU√îN 100 HP HI·ªÜN T·∫†I
                    if (type === 'hp') {
                        const stats = getTotalStats(); // L·∫•y maxHp m·ªõi (ƒë√£ + 100)
                        gameState.player.hp = Math.min(gameState.player.hp + 100, stats.totalHp);
                        saveGame();
                    }
                    
                    addLog(`‚úÖ Buff ${type.toUpperCase()} trong 10 ph√∫t!`, 'success');
                } else if (type === 'coin1') {
                    const bonus = calculateAdReward();
                    gameState.player.gold += bonus;
                    saveGame();
                    addLog(`üí∞ +${bonus} V√†ng t·ª´ qu·∫£ng c√°o!`, 'success');
                } else if (type === 'coin2') {
                    const bonus = calculateAdReward() * 2;
                    gameState.player.gold += bonus;
                    saveGame();
                    addLog(`üíé +${bonus} V√†ng t·ª´ 2 qu·∫£ng c√°o!`, 'success');
                }
                render();
            }, 2000);
        }

        // HELPER: T√çNH TH·ªúI GIAN C√íN L·∫†I
        function getBuffTimeLeft(type) {
            if (!gameState.adBoosts[type].active) return 0;
            const now = Date.now();
            if (now >= gameState.adBoosts[type].endTime) {
                gameState.adBoosts[type].active = false;
                return 0;
            }
            return Math.ceil((gameState.adBoosts[type].endTime - now) / 60000); // ph√∫t
        }

        // ==================== WITHDRAW FUNCTIONS ====================
        async function submitWithdraw(method) {
            let formData = {};
            
            if (method === 'bank') {
                formData = {
                    bankName: document.getElementById('bankName').value,
                    account: document.getElementById('bankAccount').value,
                    owner: document.getElementById('bankOwner').value,
                    amount: document.getElementById('bankAmount').value
                };
                
                if (!formData.account || !formData.owner || !formData.amount) {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                    return;
                }

                if (parseInt(formData.amount) < 20000) {
                    alert('S·ªë ti·ªÅn t·ªëi thi·ªÉu l√† 20,000ƒë');
                    return;
                }
            } else if (method === 'momo') {
                formData = {
                    phone: document.getElementById('momoPhone').value,
                    owner: document.getElementById('momoOwner').value,
                    amount: document.getElementById('momoAmount').value
                };
                
                if (!formData.phone || !formData.owner || !formData.amount) {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                    return;
                }

                if (parseInt(formData.amount) < 20000) {
                    alert('S·ªë ti·ªÅn t·ªëi thi·ªÉu l√† 20,000ƒë');
                    return;
                }
            } else if (method === 'card') {
                formData = {
                    amount: document.getElementById('cardAmount').value
                };
            }

            const withdrawAmount = parseInt(formData.amount);
            
            if (gameState.player.gold < withdrawAmount) {
                alert(`‚ùå Kh√¥ng ƒë·ªß ti·ªÅn!\n\nS·ªë d∆∞ hi·ªán t·∫°i: ${gameState.player.gold.toLocaleString()}ƒë\nS·ªë ti·ªÅn mu·ªën r√∫t: ${withdrawAmount.toLocaleString()}ƒë`);
                return;
            }
            
            gameState.player.gold -= withdrawAmount;
            await saveGame();

            await DB.addWithdrawRequest(gameState.currentUsername, method, withdrawAmount, formData);
            
            alert(`‚úÖ Y√™u c·∫ßu r√∫t ${withdrawAmount.toLocaleString()}ƒë ƒë√£ ƒë∆∞·ª£c g·ª≠i!\n\nS·ªë d∆∞ c√≤n l·∫°i: ${gameState.player.gold.toLocaleString()}ƒë\n\nVui l√≤ng ch·ªù admin duy·ªát.`);
            gameState.currentView = 'withdraw-history';
            document.getElementById('withdrawForm').classList.add('hidden');
            render();
        }

        function showWithdrawForm(method) {
            const formContainer = document.getElementById('withdrawForm');
            formContainer.className = 'bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-xl p-4 md:p-6 border-2 border-purple-500/30 slide-in';
            
            let formHTML = '';
            
            if (method === 'bank') {
                formHTML = `
                    <h3 class="text-xl font-bold mb-4 text-center">üè¶ R√öT QUA NG√ÇN H√ÄNG</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">T√™n Ng√¢n H√†ng</label>
                            <select id="bankName" class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white">
                                <option>Vietcombank</option>
                                <option>VietinBank</option>
                                <option>BIDV</option>
                                <option>Techcombank</option>
                                <option>MB Bank</option>
                                <option>ACB</option>
                                <option>TPBank</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">S·ªë T√†i Kho·∫£n</label>
                            <input type="text" id="bankAccount" placeholder="Nh·∫≠p s·ªë t√†i kho·∫£n" class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">T√™n Ng∆∞·ªùi Th·ª• H∆∞·ªüng</label>
                            <input type="text" id="bankOwner" placeholder="VD: NGUYEN VAN A" class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">S·ªë Ti·ªÅn (Min: 20,000ƒë)</label>
                            <input type="number" id="bankAmount" placeholder="20000" min="20000" class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white">
                        </div>
                        <button onclick="submitWithdraw('bank')" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-bold text-lg">
                            ‚úÖ X√ÅC NH·∫¨N R√öT TI·ªÄN
                        </button>
                    </div>
                `;
            } else if (method === 'momo') {
                formHTML = `
                    <h3 class="text-xl font-bold mb-4 text-center">üì± R√öT QUA MOMO</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">S·ªë ƒêi·ªán Tho·∫°i</label>
                            <input type="tel" id="momoPhone" placeholder="0123456789" class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">T√™n Ng∆∞·ªùi Th·ª• H∆∞·ªüng</label>
                            <input type="text" id="momoOwner" placeholder="NGUYEN VAN A" class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">S·ªë Ti·ªÅn (Min: 20,000ƒë)</label>
                            <input type="number" id="momoAmount" placeholder="20000" min="20000" class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white">
                        </div>
                        <button onclick="submitWithdraw('momo')" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-bold text-lg">
                            ‚úÖ X√ÅC NH·∫¨N R√öT TI·ªÄN
                        </button>
                    </div>
                `;
            } else if (method === 'card') {
                formHTML = `
                    <h3 class="text-xl font-bold mb-4 text-center">üé´ R√öT TH·∫∫ C√ÄO VIETTEL</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">M·ªánh Gi√°</label>
                            <select id="cardAmount" class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white">
                                <option value="10000">10,000ƒë</option>
                                <option value="20000">20,000ƒë</option>
                                <option value="50000">50,000ƒë</option>
                                <option value="100000">100,000ƒë</option>
                            </select>
                        </div>
                        <div class="bg-yellow-900/30 rounded-lg p-3 text-sm text-yellow-200">
                            <p>üìù <strong>L∆∞u √Ω:</strong></p>
                            <ul class="mt-2 space-y-1 text-xs">
                                <li>‚Ä¢ M√£ th·∫ª s·∫Ω ƒë∆∞·ª£c g·ª≠i v√†o L·ªãch S·ª≠ R√∫t Ti·ªÅn</li>
                                <li>‚Ä¢ Th·ªùi gian x·ª≠ l√Ω: 1-24 gi·ªù</li>
                                <li>‚Ä¢ Ki·ªÉm tra k·ªπ tr∆∞·ªõc khi n·∫°p</li>
                            </ul>
                        </div>
                        <button onclick="submitWithdraw('card')" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-bold text-lg">
                            ‚úÖ X√ÅC NH·∫¨N R√öT TH·∫∫
                        </button>
                    </div>
                `;
            }
            
            formHTML += `
                <button onclick="document.getElementById('withdrawForm').classList.add('hidden')" class="w-full mt-4 py-3 bg-gray-600 hover:bg-gray-700 rounded-xl font-bold">
                    ‚ùå H·ª¶Y
                </button>
            `;
            
            formContainer.innerHTML = formHTML;
        }

        // ==================== ADMIN FUNCTIONS ====================
        async function approveWithdraw(requestId) {
            if (confirm('X√°c nh·∫≠n duy·ªát y√™u c·∫ßu n√†y?')) {
                await DB.updateWithdrawStatus(requestId, 'approved');
                addLog('‚úÖ ƒê√£ duy·ªát y√™u c·∫ßu r√∫t ti·ªÅn!', 'success');
                render();
            }
        }

        async function rejectWithdraw(requestId) {
            if (confirm('X√°c nh·∫≠n t·ª´ ch·ªëi y√™u c·∫ßu n√†y? Ti·ªÅn s·∫Ω ƒë∆∞·ª£c ho√†n l·∫°i cho user.')) {
                const allRequests = await DB.getAllWithdrawRequests();
                const request = allRequests.find(r => r.id === requestId);
                
                if (request && request.status === 'pending') {
                    const userData = await DB.getPlayerData(request.username);
                    if (userData) {
                        userData.gold += request.amount;
                        await DB.savePlayerData(request.username, userData);
                        console.log(`üí∞ ƒê√£ ho√†n ${request.amount}ƒë cho ${request.username}`);
                    }
                }
                
                await DB.updateWithdrawStatus(requestId, 'rejected');
                addLog('‚ùå ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu r√∫t ti·ªÅn v√† ho√†n l·∫°i ti·ªÅn!', 'error');
                render();
            }
        }

        async function deleteWithdraw(requestId) {
            if (confirm('X√≥a y√™u c·∫ßu n√†y kh·ªèi danh s√°ch? N·∫øu ƒëang pending, ti·ªÅn s·∫Ω ƒë∆∞·ª£c ho√†n l·∫°i.')) {
                const allRequests = await DB.getAllWithdrawRequests();
                const request = allRequests.find(r => r.id === requestId);
                
                if (request && request.status === 'pending') {
                    const userData = await DB.getPlayerData(request.username);
                    if (userData) {
                        userData.gold += request.amount;
                        await DB.savePlayerData(request.username, userData);
                        console.log(`üí∞ ƒê√£ ho√†n ${request.amount}ƒë cho ${request.username}`);
                    }
                }
                
                await DB.deleteWithdrawRequest(requestId);
                addLog('üóëÔ∏è ƒê√£ x√≥a y√™u c·∫ßu!', 'info');
                render();
            }
        }

        async function addAdminUser() {
            const username = prompt('Nh·∫≠p username ƒë·ªÉ th√™m v√†o Admin:');
            if (username) {
                const result = await DB.addAdmin(username.trim());
                alert(result.message);
                if (result.success) {
                    render();
                }
            }
        }

        async function removeAdminUser(username) {
            if (confirm(`G·ª° quy·ªÅn Admin c·ªßa ${username}?`)) {
                const result = await DB.removeAdmin(username);
                alert(result.message);
                if (result.success) {
                    render();
                }
            }
        }

        async function showModifyGoldForm() {
            const allUsers = await DB.getAllUsers();
            const usernames = Object.keys(allUsers);
            
            if (usernames.length === 0) {
                alert('Kh√¥ng c√≥ user n√†o trong h·ªá th·ªëng!');
                return;
            }

            let userList = 'Danh s√°ch users:\n\n';
            usernames.forEach((name, index) => {
                const gold = allUsers[name].playerData.gold;
                userList += `${index + 1}. ${name} - V√†ng: ${gold.toLocaleString()}ƒë\n`;
            });

            const username = prompt(userList + '\nNh·∫≠p username c·∫ßn c·ªông/tr·ª´ ti·ªÅn:');
            if (!username) return;

            const trimmedUsername = username.trim();
            const exists = await DB.userExists(trimmedUsername);

            if (!exists) {
                alert(`‚ùå User "${trimmedUsername}" kh√¥ng t·ªìn t·∫°i!\n\nC√°c user c√≥ trong h·ªá th·ªëng:\n${usernames.join(', ')}`);
                return;
            }

            const currentGold = allUsers[trimmedUsername].playerData.gold;
            const amountStr = prompt(`User: ${trimmedUsername}\nS·ªë d∆∞ hi·ªán t·∫°i: ${currentGold.toLocaleString()}ƒë\n\nNh·∫≠p s·ªë ti·ªÅn:\n‚Ä¢ S·ªë D∆Ø∆†NG ƒë·ªÉ C·ªòNG ti·ªÅn (VD: 1000)\n‚Ä¢ S·ªë √ÇM ƒë·ªÉ TR·ª™ ti·ªÅn (VD: -500)`);
            
            if (!amountStr) return;

            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount === 0) {
                alert('‚ùå S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá!');
                return;
            }

            const result = await DB.modifyUserGold(trimmedUsername, amount);
            
            if (result.success) {
                const action = amount > 0 ? 'C·ªòNG' : 'TR·ª™';
                alert(`‚úÖ ƒê√£ ${action} ${Math.abs(amount).toLocaleString()}ƒë cho ${trimmedUsername}!\n\nS·ªë d∆∞ m·ªõi: ${result.gold.toLocaleString()}ƒë`);
                
                if (amount > 0) {
                    await DB.addNotification(`üí∞ Admin ƒë√£ c·ªông cho b·∫°n ${amount.toLocaleString()}ƒë!`, 'success');
                } else {
                    await DB.addNotification(`‚ö†Ô∏è Admin ƒë√£ tr·ª´ ${Math.abs(amount).toLocaleString()}ƒë t·ª´ t√†i kho·∫£n c·ªßa b·∫°n!`, 'warning');
                }
                
                render();
            } else {
                alert('‚ùå ' + result.message);
            }
        }

        async function showSendNotificationForm() {
            const message = prompt('Nh·∫≠p th√¥ng b√°o g·ª≠i to√†n server:\n\n(Th√¥ng b√°o s·∫Ω hi·ªÉn th·ªã cho t·∫•t c·∫£ ng∆∞·ªùi ch∆°i)');
            if (!message || message.trim() === '') {
                return;
            }

            const typeStr = prompt('Ch·ªçn lo·∫°i th√¥ng b√°o:\n\n1 = Th√¥ng tin (xanh)\n2 = Th√†nh c√¥ng (xanh l√°)\n3 = C·∫£nh b√°o (v√†ng)\n4 = L·ªói (ƒë·ªè)\n\nNh·∫≠p s·ªë (1-4):');
            
            const typeMap = {
                '1': 'info',
                '2': 'success',
                '3': 'warning',
                '4': 'error'
            };

            const type = typeMap[typeStr] || 'info';

            await DB.addNotification(message.trim(), type);
            
            alert('‚úÖ ƒê√£ g·ª≠i th√¥ng b√°o to√†n server!');
            
            checkNotifications();
            render();
        }

        // ==================== SUPPORT FUNCTIONS ====================
        function toggleSupport() {
            gameState.showSupport = !gameState.showSupport;
            render();
        }

        // ==================== RENDER FUNCTIONS ====================
        function renderAuthScreen() {
            if (gameState.authView === 'login') {
                return `
                    <div class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-black text-white p-4 md:p-8 flex items-center justify-center">
                        <div class="max-w-md w-full bg-gradient-to-br from-purple-800/50 to-blue-800/50 backdrop-blur-lg rounded-3xl p-6 md:p-8 shadow-2xl border border-purple-500/30 slide-in">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4 animate-bounce">‚öîÔ∏è</div>
                                <h1 class="text-4xl md:text-5xl font-bold mb-2 bg-gradient-to-r from-yellow-400 to-pink-500 bg-clip-text text-transparent">
                                    GAME RPG ONLINE
                                </h1>
                                <p class="text-purple-300">By Duc Quyet Development</p>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold mb-2 text-purple-200">üë§ Username</label>
                                    <input
                                        type="text"
                                        id="loginUsername"
                                        placeholder="Nh·∫≠p username"
                                        class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white placeholder-purple-300"
                                        onkeypress="if(event.key==='Enter') handleLogin()"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-bold mb-2 text-purple-200">üîí Password</label>
                                    <input
                                        type="password"
                                        id="loginPassword"
                                        placeholder="Nh·∫≠p password"
                                        class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white placeholder-purple-300"
                                        onkeypress="if(event.key==='Enter') handleLogin()"
                                    />
                                </div>

                                ${gameState.authError ? `<p class="text-red-400 text-sm text-center">‚ö†Ô∏è ${gameState.authError}</p>` : ''}

                                <button
                                    onclick="handleLogin()"
                                    class="w-full py-4 bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 rounded-xl font-bold text-lg shadow-lg transform hover:scale-105 transition-all duration-200"
                                >
                                    üéÆ ƒêƒÇNG NH·∫¨P
                                </button>

                                <div class="text-center">
                                    <button
                                        onclick="gameState.authView='register'; gameState.authError=''; render();"
                                        class="text-purple-300 hover:text-purple-100 text-sm underline"
                                    >
                                        Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-black text-white p-4 md:p-8 flex items-center justify-center">
                        <div class="max-w-md w-full bg-gradient-to-br from-purple-800/50 to-blue-800/50 backdrop-blur-lg rounded-3xl p-6 md:p-8 shadow-2xl border border-purple-500/30 slide-in">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4">üìù</div>
                                <h1 class="text-4xl md:text-5xl font-bold mb-2 bg-gradient-to-r from-yellow-400 to-pink-500 bg-clip-text text-transparent">
                                    ƒêƒÇNG K√ù T√ÄI KHO·∫¢N
                                </h1>
                                <p class="text-purple-300">T·∫°o t√†i kho·∫£n m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold mb-2 text-purple-200">üë§ Username</label>
                                    <input
                                        type="text"
                                        id="registerUsername"
                                        placeholder="T·ªëi thi·ªÉu 3 k√Ω t·ª±"
                                        class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white placeholder-purple-300"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-bold mb-2 text-purple-200">üîí Password</label>
                                    <input
                                        type="password"
                                        id="registerPassword"
                                        placeholder="T·ªëi thi·ªÉu 5 k√Ω t·ª±"
                                        class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white placeholder-purple-300"
                                        onkeypress="if(event.key==='Enter') handleRegister()"
                                    />
                                </div>

                                ${gameState.authError ? `<p class="text-red-400 text-sm text-center">‚ö†Ô∏è ${gameState.authError}</p>` : ''}

                                <button
                                    onclick="handleRegister()"
                                    class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-bold text-lg shadow-lg transform hover:scale-105 transition-all duration-200"
                                >
                                    ‚úÖ T·∫†O T√ÄI KHO·∫¢N
                                </button>

                                <div class="text-center">
                                    <button
                                        onclick="gameState.authView='login'; gameState.authError=''; render();"
                                        class="text-purple-300 hover:text-purple-100 text-sm underline"
                                    >
                                        ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function renderNotificationBanner() {
            if (!gameState.currentNotification) return '';

            const notif = gameState.currentNotification;

            return `
                <div class="notification-banner slide-down">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="text-3xl">üì¢</div>
                                <div class="flex-1">
                                    <div class="font-bold text-lg">TH√îNG B√ÅO T·ª™ ADMIN</div>
                                    <div class="text-sm">${notif.message}</div>
                                </div>
                            </div>
                            <button
                                onclick="dismissCurrentNotification()"
                                class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg font-bold text-sm whitespace-nowrap"
                            >
                                ‚úï ƒê√≥ng
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGameView() {
            const stats = getTotalStats();
            
            return `
                <div class="grid lg:grid-cols-2 gap-4 md:gap-6">
                    <!-- Battle Arena -->
                    <div class="bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-2xl p-4 md:p-6 border-2 border-purple-500/30 shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-yellow-400 to-pink-500 bg-clip-text text-transparent">
                                ‚öîÔ∏è CHI·∫æN TR∆Ø·ªúNG
                            </h2>
                            <button
                                onclick="toggleAutoFight()"
                                class="px-3 py-1 rounded-lg text-xs md:text-sm font-bold ${
                                    gameState.autoFight 
                                        ? 'bg-green-600 hover:bg-green-700' 
                                        : 'bg-gray-600 hover:bg-gray-700'
                                }"
                            >
                                ${gameState.autoFight ? 'üîÑ Auto ON' : '‚è∏Ô∏è Auto OFF'}
                            </button>
                        </div>
                        
                        ${!gameState.isInBattle ? `
                            <div class="text-center space-y-4">
                                <div class="text-6xl mb-4 animate-bounce">üè∞</div>
                                <p class="text-purple-300 mb-4">·∫¢i ${gameState.player.currentStage} - Qu√°i ƒë√£ ti√™u di·ªát: ${gameState.player.totalMonstersKilled}</p>
                                <p class="text-yellow-300 text-sm">
                                    ${gameState.player.totalMonstersKilled % 10 === 0 && gameState.player.totalMonstersKilled > 0 ? 'üëπ BOSS ·∫¢I S·∫ÆP XU·∫§T HI·ªÜN!' : `C√≤n ${10 - (gameState.player.totalMonstersKilled % 10)} qu√°i n·ªØa g·∫∑p Boss ·∫¢i`}
                                </p>
                                ${gameState.autoFight ? `
                                    <div class="bg-green-900/30 border border-green-500/50 rounded-lg p-3">
                                        <p class="text-green-300 text-sm animate-pulse">‚ö° ƒêang t·ª± ƒë·ªông spawn qu√°i...</p>
                                    </div>
                                ` : `
                                    <button 
                                        onclick="startBattle(); render();"
                                        class="w-full py-4 bg-gradient-to-r from-red-500 to-orange-600 hover:from-red-600 hover:to-orange-700 rounded-xl font-bold text-lg shadow-lg transform hover:scale-105 transition-all"
                                    >
                                        ‚öîÔ∏è B·∫ÆT ƒê·∫¶U CHI·∫æN ƒê·∫§U
                                    </button>
                                `}
                            </div>
                        ` : `
                            <div class="space-y-4">
                                <div 
                                    onclick="playerAttack(event)"
                                    class="bg-red-900/30 rounded-xl p-4 md:p-6 border-2 border-red-500/50 cursor-pointer hover:bg-red-800/40 hover:border-red-400 hover:scale-105 transition-all duration-200 relative overflow-hidden active:scale-95"
                                >
                                    <div class="text-center">
                                        <div class="text-5xl md:text-7xl mb-3 animate-bounce">${gameState.monster.icon}</div>
                                        <h3 class="font-bold text-xl md:text-2xl text-red-300 mb-2">${gameState.monster.name}</h3>
                                        <div class="bg-black/50 rounded-lg p-3">
                                            <div class="flex items-center justify-center gap-2 mb-2">
                                                <span>‚ù§Ô∏è</span>
                                                <span class="font-bold text-lg">${gameState.monster.hp}/${gameState.monster.maxHp}</span>
                                            </div>
                                            <div class="w-full bg-black/50 rounded-full h-4">
                                                <div class="bg-gradient-to-r from-red-600 to-pink-500 h-full transition-all" style="width: ${(gameState.monster.hp / gameState.monster.maxHp) * 100}%"></div>
                                            </div>
                                        </div>
                                        <div class="mt-4 text-yellow-300 text-sm animate-pulse">üëÜ CLICK ƒê·ªÇ T·∫§N C√îNG!</div>
                                    </div>
                                </div>

                                <div class="text-center">
                                    <span class="text-3xl font-bold bg-gradient-to-r from-yellow-400 to-red-500 bg-clip-text text-transparent">‚ö° VS ‚ö°</span>
                                </div>

                                <div class="bg-blue-900/30 rounded-xl p-4 border-2 border-blue-500/50">
                                    <div class="text-center">
                                        <div class="text-5xl mb-2">üõ°Ô∏è</div>
                                        <h3 class="font-bold text-lg text-blue-300">${gameState.player.name}</h3>
                                        <div class="mt-2">
                                            <div class="flex items-center justify-center gap-2 mb-1">
                                                <span>‚ù§Ô∏è</span>
                                                <span class="font-bold">${gameState.player.hp}/${stats.totalHp}</span>
                                            </div>
                                            <div class="w-full bg-black/50 rounded-full h-3">
                                                <div class="bg-gradient-to-r from-green-600 to-emerald-500 h-full transition-all" style="width: ${(gameState.player.hp / stats.totalHp) * 100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>

                    <!-- Battle Log & Equipment -->
                    <div class="space-y-4">
                        <div class="bg-black/50 rounded-2xl p-4 border-2 border-purple-500/30">
                            <h3 class="text-lg font-bold mb-4">‚ú® Nh·∫≠t K√Ω</h3>
                            <div class="space-y-2 max-h-48 overflow-y-auto">
                                ${gameState.battleLog.length === 0 ? 
                                    '<p class="text-purple-300 text-center py-4">Ch∆∞a c√≥ tr·∫≠n chi·∫øn...</p>' :
                                    gameState.battleLog.map(log => `
                                        <div class="p-2 rounded-lg text-sm ${
                                            log.type === 'success' ? 'bg-green-900/30 text-green-300' :
                                            log.type === 'error' ? 'bg-red-900/30 text-red-300' :
                                            'bg-blue-900/30 text-blue-300'
                                        }">
                                            ${log.message}
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-purple-900/50 to-pink-900/50 rounded-2xl p-4 border-2 border-purple-500/30">
                            <h3 class="text-lg font-bold mb-4">üëë Trang B·ªã</h3>
                            <div class="space-y-3">
                                <div class="bg-black/30 p-3 rounded-lg">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-purple-300">‚öîÔ∏è V≈© Kh√≠:</span>
                                        <span class="font-bold">${gameState.player.weapon ? `${gameState.player.weapon.icon} ${gameState.player.weapon.name}` : 'Ch∆∞a c√≥'}</span>
                                    </div>
                                </div>
                                <div class="bg-black/30 p-3 rounded-lg">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-purple-300">üõ°Ô∏è Gi√°p:</span>
                                        <span class="font-bold">${gameState.player.armor ? `${gameState.player.armor.icon} ${gameState.player.armor.name}` : 'Ch∆∞a c√≥'}</span>
                                    </div>
                                </div>
                                <div class="bg-black/30 p-3 rounded-lg">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-purple-300">üêæ Pet:</span>
                                        <span class="font-bold">${gameState.player.pet ? `${gameState.player.pet.icon} ${gameState.player.pet.name}` : 'Ch∆∞a c√≥'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUpgradeView() {
            const upgradeItems = [
                { stat: 'atk', label: 'S·ª©c M·∫°nh', icon: '‚öîÔ∏è', current: gameState.player.atk, bonus: '+5 ATK', color: 'from-orange-500 to-red-600', cost: 100 + gameState.player.atk * 50 },
                { stat: 'hp', label: 'M√°u', icon: '‚ù§Ô∏è', current: gameState.player.maxHp, bonus: '+20 HP', color: 'from-red-500 to-pink-600', cost: 150 + gameState.player.maxHp * 2 },
                { stat: 'crit', label: 'Ch√≠ M·∫°ng', icon: '‚ö°', current: gameState.player.crit, bonus: '+2% CRIT', color: 'from-yellow-500 to-orange-600', cost: 200 + gameState.player.crit * 100 }
            ];

            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center bg-gradient-to-r from-yellow-400 to-pink-500 bg-clip-text text-transparent">
                        ‚¨ÜÔ∏è N√ÇNG C·∫§P NH√ÇN V·∫¨T
                    </h2>
                    <div class="grid md:grid-cols-3 gap-4">
                        ${upgradeItems.map(item => `
                            <div class="bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-2xl p-4 md:p-6 border-2 border-purple-500/30">
                                <div class="text-center mb-4">
                                    <div class="text-4xl md:text-5xl mb-2">${item.icon}</div>
                                    <h3 class="font-bold text-lg">${item.label}</h3>
                                    <p class="text-purple-300 text-sm mt-1">Hi·ªán t·∫°i: ${item.current}</p>
                                </div>
                                <button
                                    onclick="upgradeStats('${item.stat}')"
                                    class="w-full py-3 bg-gradient-to-r ${item.color} hover:scale-105 rounded-xl font-bold shadow-lg transform transition-all"
                                >
                                    ${item.bonus}
                                    <div class="text-sm mt-1">üí∞ ${item.cost.toLocaleString()}ƒë</div>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderShopView() {
            return `
                <div class="space-y-6 md:space-y-8">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold mb-4 text-center bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                            ‚öîÔ∏è SHOP V≈® KH√ç
                        </h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 md:gap-4">
                            ${window.weaponShop.map((weapon, idx) => {
                                const isEquipped = gameState.player.weapon?.name === weapon.name;
                                const isOwned = (gameState.player.ownedWeapons || []).some(w => w.name === weapon.name);
                                
                                return `
                                <div class="bg-gradient-to-br from-orange-900/50 to-red-900/50 rounded-xl p-3 md:p-4 border-2 ${
                                    isEquipped ? 'border-green-500 ring-2 ring-green-400' : 'border-orange-500/30'
                                } hover:border-orange-400 transition-all hover:scale-105">
                                    <div class="text-center">
                                        <div class="text-3xl md:text-4xl mb-2">${weapon.icon}</div>
                                        <h3 class="font-bold text-sm">${weapon.name}</h3>
                                        <p class="text-orange-300 text-xs">+${weapon.atk} ATK</p>
                                        ${isEquipped ? `
                                            <div class="mt-3 w-full py-2 bg-green-600 rounded-lg font-bold text-xs">
                                                ‚úì ƒêang d√πng
                                            </div>
                                        ` : isOwned ? `
                                            <button
                                                onclick="equipItem(weaponShop[${idx}], 'weapon')"
                                                class="mt-3 w-full py-2 rounded-lg font-bold text-xs bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700"
                                            >
                                                üîÑ Trang b·ªã
                                            </button>
                                        ` : `
                                            <button
                                                onclick="buyItem(weaponShop[${idx}], 'weapon')"
                                                class="mt-3 w-full py-2 rounded-lg font-bold text-xs bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700"
                                            >
                                                üí∞ ${weapon.price}ƒë
                                            </button>
                                        `}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>

                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold mb-4 text-center bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                            üõ°Ô∏è SHOP GI√ÅP
                        </h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-4">
                            ${window.armorShop.map((armor, idx) => {
                                const isEquipped = gameState.player.armor?.name === armor.name;
                                const isOwned = (gameState.player.ownedArmors || []).some(a => a.name === armor.name);
                                
                                return `
                                <div class="bg-gradient-to-br from-blue-900/50 to-purple-900/50 rounded-xl p-3 md:p-4 border-2 ${
                                    isEquipped ? 'border-green-500 ring-2 ring-green-400' : 'border-blue-500/30'
                                } hover:border-blue-400 transition-all hover:scale-105">
                                    <div class="text-center">
                                        <div class="text-3xl md:text-4xl mb-2">${armor.icon}</div>
                                        <h3 class="font-bold text-sm">${armor.name}</h3>
                                        <p class="text-blue-300 text-xs">+${armor.def} DEF</p>
                                        <p class="text-red-300 text-xs">+${armor.hp} HP</p>
                                        ${isEquipped ? `
                                            <div class="mt-3 w-full py-2 bg-green-600 rounded-lg font-bold text-xs">
                                                ‚úì ƒêang d√πng
                                            </div>
                                        ` : isOwned ? `
                                            <button
                                                onclick="equipItem(armorShop[${idx}], 'armor')"
                                                class="mt-3 w-full py-2 rounded-lg font-bold text-xs bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700"
                                            >
                                                üîÑ Trang b·ªã
                                            </button>
                                        ` : `
                                            <button
                                                onclick="buyItem(armorShop[${idx}], 'armor')"
                                                class="mt-3 w-full py-2 rounded-lg font-bold text-xs bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700"
                                            >
                                                üí∞ ${armor.price}ƒë
                                            </button>
                                        `}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>

                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold mb-4 text-center bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent">
                            üêæ SHOP PET
                        </h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-4">
                            ${window.petShop.map((pet, idx) => {
                                const isEquipped = gameState.player.pet?.name === pet.name;
                                const isOwned = (gameState.player.ownedPets || []).some(p => p.name === pet.name);
                                
                                return `
                                <div class="bg-gradient-to-br from-green-900/50 to-emerald-900/50 rounded-xl p-3 md:p-4 border-2 ${
                                    isEquipped ? 'border-green-500 ring-2 ring-green-400' : 'border-green-500/30'
                                } hover:border-green-400 transition-all hover:scale-105">
                                    <div class="text-center">
                                        <div class="text-3xl md:text-4xl mb-2">${pet.icon}</div>
                                        <h3 class="font-bold text-sm">${pet.name}</h3>
                                        <p class="text-green-300 text-xs">+${pet.atkBonus}% ATK</p>
                                        ${isEquipped ? `
                                            <div class="mt-3 w-full py-2 bg-green-600 rounded-lg font-bold text-xs">
                                                ‚úì ƒêang d√πng
                                            </div>
                                        ` : isOwned ? `
                                            <button
                                                onclick="equipItem(petShop[${idx}], 'pet')"
                                                class="mt-3 w-full py-2 rounded-lg font-bold text-xs bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700"
                                            >
                                                üîÑ Tri·ªáu h·ªìi
                                            </button>
                                        ` : `
                                            <button
                                                onclick="buyItem(petShop[${idx}], 'pet')"
                                                class="mt-3 w-full py-2 rounded-lg font-bold text-xs bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700"
                                            >
                                                üí∞ ${pet.price}ƒë
                                            </button>
                                        `}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBossView() {
            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center bg-gradient-to-r from-red-400 to-orange-500 bg-clip-text text-transparent">
                        üëë BOSS T·ª∞ CH·ªåN
                    </h2>
                    <div class="grid md:grid-cols-2 gap-4 md:gap-6">
                        <div class="bg-gradient-to-br from-red-900/50 to-orange-900/50 rounded-2xl p-4 md:p-6 border-2 border-red-500/30">
                            <div class="text-center mb-4">
                                <div class="text-5xl md:text-6xl mb-2">üî•</div>
                                <h3 class="text-xl md:text-2xl font-bold text-red-300">BOSS NG√ÄY</h3>
                                <p class="text-sm text-orange-300 mt-2">Ph·∫ßn th∆∞·ªüng x5 V√†ng!</p>
                            </div>
                            <div class="bg-black/30 rounded-lg p-3 mb-4">
                                <p class="text-center">L∆∞·ª£t c√≤n l·∫°i: <span class="font-bold text-yellow-400">${gameState.player.dailyBosses}/2</span></p>
                            </div>
                            <button
                                onclick="startBattle('daily'); render();"
                                ${gameState.player.dailyBosses <= 0 ? 'disabled' : ''}
                                class="w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all ${
                                    gameState.player.dailyBosses > 0
                                        ? 'bg-gradient-to-r from-red-500 to-orange-600 hover:from-red-600 hover:to-orange-700 hover:scale-105'
                                        : 'bg-gray-600 cursor-not-allowed opacity-50'
                                }"
                            >
                                ${gameState.player.dailyBosses > 0 ? '‚öîÔ∏è TH√ÅCH ƒê·∫§U' : '‚ùå H·∫øt l∆∞·ª£t'}
                            </button>
                        </div>

                        <div class="bg-gradient-to-br from-purple-900/50 to-pink-900/50 rounded-2xl p-4 md:p-6 border-2 border-purple-500/30">
                            <div class="text-center mb-4">
                                <div class="text-5xl md:text-6xl mb-2">‚ö°</div>
                                <h3 class="text-xl md:text-2xl font-bold text-purple-300">BOSS TU·∫¶N</h3>
                                <p class="text-sm text-pink-300 mt-2">Ph·∫ßn th∆∞·ªüng x8 V√†ng!</p>
                            </div>
                            <div class="bg-black/30 rounded-lg p-3 mb-4">
                                <p class="text-center">L∆∞·ª£t c√≤n l·∫°i: <span class="font-bold text-yellow-400">${gameState.player.weeklyBosses}/3</span></p>
                            </div>
                            <button
                                onclick="startBattle('weekly'); render();"
                                ${gameState.player.weeklyBosses <= 0 ? 'disabled' : ''}
                                class="w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all ${
                                    gameState.player.weeklyBosses > 0
                                        ? 'bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 hover:scale-105'
                                        : 'bg-gray-600 cursor-not-allowed opacity-50'
                                }"
                            >
                                ${gameState.player.weeklyBosses > 0 ? '‚öîÔ∏è TH√ÅCH ƒê·∫§U' : '‚ùå H·∫øt l∆∞·ª£t'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdsView() {
            const adReward = calculateAdReward();
            
            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
                        üì∫ XEM QU·∫¢NG C√ÅO NH·∫¨N TH∆Ø·ªûNG
                    </h2>
                    
                    <div class="bg-green-900/30 border-2 border-green-500/50 rounded-xl p-4 mb-6">
                        <p class="text-center text-green-300 text-sm md:text-base">
                            ‚úÖ <strong>ADSTERRA TH·∫¨T:</strong> Social Bar + Smart Link + Popup
                        </p>
                        <p class="text-center text-green-200 text-xs mt-2">
                            S·ªë QC ƒë√£ xem: ${gameState.adsWatched}
                        </p>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-xl p-4 md:p-6 border-2 border-purple-500/30">
                            <h3 class="text-lg md:text-xl font-bold mb-4">‚ö° BUFF STATS (10 ph√∫t - KH√îNG STACK)</h3>
                            <div class="grid md:grid-cols-3 gap-3 md:gap-4">
                                ${[
                                    { type: 'hp', label: '+100 HP', icon: '‚ù§Ô∏è', color: 'from-red-500 to-pink-600' },
                                    { type: 'atk', label: '+75 ATK', icon: '‚öîÔ∏è', color: 'from-orange-500 to-red-600' },
                                    { type: 'def', label: '+10 DEF', icon: 'üõ°Ô∏è', color: 'from-blue-500 to-purple-600' }
                                ].map(boost => {
                                    const timeLeft = getBuffTimeLeft(boost.type);
                                    const isActive = timeLeft > 0;
                                    
                                    return `
                                        <button
                                            onclick="watchAd('${boost.type}');"
                                            ${isActive ? 'disabled' : ''}
                                            class="py-4 rounded-xl font-bold bg-gradient-to-r ${boost.color} hover:scale-105 transform transition-all ${
                                                isActive ? 'opacity-50 cursor-not-allowed' : ''
                                            }"
                                        >
                                            <div class="text-2xl mb-1">${boost.icon}</div>
                                            <div>${boost.label}</div>
                                            ${isActive ? `<div class="text-xs mt-1">‚è≥ C√≤n ${timeLeft} ph√∫t</div>` : '<div class="text-xs mt-1">üì∫ Xem QC</div>'}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-yellow-900/50 to-orange-900/50 rounded-xl p-4 md:p-6 border-2 border-yellow-500/30">
                            <h3 class="text-lg md:text-xl font-bold mb-4">üí∞ NH·∫¨N V√ÄNG (ƒê√É GI·∫¢M ƒê·ªÇ C√ÇN B·∫∞NG)</h3>
                            <div class="grid md:grid-cols-2 gap-3 md:gap-4">
                                <button
                                    onclick="watchAd('coin1');"
                                    class="py-4 rounded-xl font-bold bg-gradient-to-r from-yellow-500 to-orange-600 hover:scale-105 transform transition-all"
                                >
                                    <div class="text-2xl mb-1">üí∞</div>
                                    <div>+~${adReward}ƒë</div>
                                    <div class="text-xs mt-1">(1 QC)</div>
                                </button>
                                <button
                                    onclick="watchAd('coin2');"
                                    class="py-4 rounded-xl font-bold bg-gradient-to-r from-yellow-500 to-orange-600 hover:scale-105 transform transition-all"
                                >
                                    <div class="text-2xl mb-1">üíé</div>
                                    <div>+~${adReward * 2}ƒë</div>
                                    <div class="text-xs mt-1">(2 QC)</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderMarketView() {
            try {
                const myListings = await DB.getMyListings(gameState.currentUsername);
                const othersListings = await DB.getOthersListings(gameState.currentUsername);

                if (gameState.marketView === 'sell') {
                    const sellableWeapons = (gameState.player.ownedWeapons || []).filter(w => gameState.player.weapon?.name !== w.name);
                    const sellableArmors = (gameState.player.ownedArmors || []).filter(a => gameState.player.armor?.name !== a.name);
                    const sellablePets = (gameState.player.ownedPets || []).filter(p => gameState.player.pet?.name !== p.name);

                    return `
                        <div class="max-w-4xl mx-auto">
                            <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">
                                üè™ ƒêƒÇNG B√ÅN ƒê·ªí
                            </h2>

                            <button
                                onclick="gameState.marketView='browse'; render();"
                                class="mb-4 px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg"
                            >
                                ‚Üê Quay l·∫°i Ch·ª£
                        </button>

                        ${gameState.selectedItemToSell ? `
                            <div class="bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-xl p-6 border-2 border-purple-500/30 mb-6">
                                <h3 class="text-xl font-bold mb-4 text-center">X√°c nh·∫≠n gi√° b√°n</h3>
                                <div class="text-center mb-4">
                                    <div class="text-5xl mb-2">${gameState.selectedItemToSell.item.icon}</div>
                                    <div class="font-bold text-lg">${gameState.selectedItemToSell.item.name}</div>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold mb-2">Nh·∫≠p gi√° b√°n (ƒë)</label>
                                        <input
                                            type="number"
                                            id="sellPriceInput"
                                            value="${gameState.sellPrice}"
                                            oninput="gameState.sellPrice = this.value; render();"
                                            placeholder="VD: 500"
                                            class="w-full px-4 py-3 bg-black/30 border-2 border-purple-500/50 rounded-xl focus:border-pink-500 focus:outline-none text-white"
                                        />
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <button
                                            onclick="listItemForSale()"
                                            class="py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-bold"
                                        >
                                            ‚úÖ ƒêƒÉng B√°n
                                        </button>
                                        <button
                                            onclick="gameState.selectedItemToSell=null; gameState.sellPrice=''; render();"
                                            class="py-3 bg-gray-600 hover:bg-gray-700 rounded-xl font-bold"
                                        >
                                            ‚ùå H·ªßy
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="space-y-6">
                            ${sellableWeapons.length > 0 ? `
                                <div>
                                    <h3 class="text-lg font-bold mb-3">‚öîÔ∏è V≈© Kh√≠ C√≥ Th·ªÉ B√°n</h3>
                                    <div class="grid grid-cols-3 md:grid-cols-5 gap-3">
                                        ${sellableWeapons.map(w => `
                                            <button
                                                onclick="selectItemToSell('${w.name}', 'weapon')"
                                                class="bg-orange-900/30 p-3 rounded-lg border-2 border-orange-500/30 hover:border-orange-400 hover:scale-105 transition-all"
                                            >
                                                <div class="text-3xl mb-1">${w.icon}</div>
                                                <div class="text-xs font-bold">${w.name}</div>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${sellableArmors.length > 0 ? `
                                <div>
                                    <h3 class="text-lg font-bold mb-3">üõ°Ô∏è Gi√°p C√≥ Th·ªÉ B√°n</h3>
                                    <div class="grid grid-cols-3 md:grid-cols-5 gap-3">
                                        ${sellableArmors.map(a => `
                                            <button
                                                onclick="selectItemToSell('${a.name}', 'armor')"
                                                class="bg-blue-900/30 p-3 rounded-lg border-2 border-blue-500/30 hover:border-blue-400 hover:scale-105 transition-all"
                                            >
                                                <div class="text-3xl mb-1">${a.icon}</div>
                                                <div class="text-xs font-bold">${a.name}</div>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${sellablePets.length > 0 ? `
                                <div>
                                    <h3 class="text-lg font-bold mb-3">üêæ Pet C√≥ Th·ªÉ B√°n</h3>
                                    <div class="grid grid-cols-3 md:grid-cols-5 gap-3">
                                        ${sellablePets.map(p => `
                                            <button
                                                onclick="selectItemToSell('${p.name}', 'pet')"
                                                class="bg-green-900/30 p-3 rounded-lg border-2 border-green-500/30 hover:border-green-400 hover:scale-105 transition-all"
                                            >
                                                <div class="text-3xl mb-1">${p.icon}</div>
                                                <div class="text-xs font-bold">${p.name}</div>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${sellableWeapons.length === 0 && sellableArmors.length === 0 && sellablePets.length === 0 ? `
                                <div class="bg-yellow-900/30 border-2 border-yellow-500/50 rounded-xl p-8 text-center">
                                    <p class="text-yellow-300">Kh√¥ng c√≥ ƒë·ªì ƒë·ªÉ b√°n!</p>
                                    <p class="text-sm text-yellow-200 mt-2">G·ª° trang b·ªã tr∆∞·ªõc khi b√°n ho·∫∑c mua th√™m ƒë·ªì m·ªõi.</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">
                        üè™ CH·ª¢ TRADE TH√ÄNH VI√äN
                    </h2>

                    <div class="bg-green-900/30 border-2 border-green-500/50 rounded-xl p-4 mb-6">
                        <p class="text-center text-green-300 font-bold">
                            ‚úÖ FIREBASE REALTIME - Mua b√°n t·ª± do gi·ªØa c√°c th√†nh vi√™n!
                        </p>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-xl p-4 md:p-6 border-2 border-purple-500/30">
                            <h3 class="text-lg md:text-xl font-bold mb-4">üì¶ ƒê·ªì C·ªßa T√¥i ƒêang B√°n</h3>
                            <div class="space-y-2 mb-4">
                                ${myListings.length === 0 ? 
                                    '<p class="text-center text-purple-300 py-8">B·∫°n ch∆∞a ƒëƒÉng b√°n g√¨</p>' :
                                    myListings.map(listing => `
                                        <div class="bg-black/30 p-3 rounded-lg">
                                            <div class="flex justify-between items-center">
                                                <div class="flex items-center gap-3">
                                                    <div class="text-3xl">${listing.item.icon}</div>
                                                    <div>
                                                        <div class="font-bold">${listing.item.name}</div>
                                                        <div class="text-xs text-yellow-400">üí∞ ${listing.price.toLocaleString()}ƒë</div>
                                                    </div>
                                                </div>
                                                <button 
                                                    onclick="removeListing(${listing.id})"
                                                    class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded-lg text-sm"
                                                >
                                                    G·ª°
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                            
                            <button 
                                onclick="gameState.marketView='sell'; render();"
                                class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 rounded-xl font-bold"
                            >
                                ‚ûï ƒêƒÇNG B√ÅN ƒê·ªí
                            </button>
                        </div>

                        <div class="bg-gradient-to-br from-pink-900/50 to-purple-900/50 rounded-xl p-4 md:p-6 border-2 border-pink-500/30">
                            <h3 class="text-lg md:text-xl font-bold mb-4">üõí ƒê·ªì ƒêang B√°n</h3>
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                ${othersListings.length === 0 ? 
                                    '<p class="text-center text-pink-300 py-8">Ch∆∞a c√≥ ƒë·ªì n√†o tr√™n ch·ª£</p>' :
                                    othersListings.map(listing => `
                                        <div class="bg-black/30 p-3 rounded-lg hover:bg-black/50 transition-all">
                                            <div class="flex justify-between items-center">
                                                <div class="flex items-center gap-3">
                                                    <div class="text-3xl">${listing.item.icon}</div>
                                                    <div>
                                                        <div class="font-bold">${listing.item.name}</div>
                                                        <div class="text-xs text-purple-300">Ng∆∞·ªùi b√°n: ${listing.seller}</div>
                                                    </div>
                                                </div>
                                                <button 
                                                    onclick="buyFromMarket(${listing.id})"
                                                    class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded-lg text-sm font-bold"
                                                >
                                                    üí∞ ${listing.price.toLocaleString()}ƒë
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
            } catch (error) {
                console.error("‚ùå Error in renderMarketView:", error);
                return `<div class="text-center text-red-400 p-8">L·ªói hi·ªÉn th·ªã ch·ª£: ${error.message}</div>`;
            }
        }

        function renderWithdrawView() {
            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent">
                        üíµ R√öT TI·ªÄN
                    </h2>
                    
                    <div class="bg-green-900/30 border-2 border-green-500/50 rounded-xl p-4 mb-6">
                        <p class="text-center text-green-300 font-bold text-sm md:text-base">
                            ‚úÖ FIREBASE REALTIME - G·ª≠i y√™u c·∫ßu v√† ch·ªù admin duy·ªát!
                        </p>
                        <p class="text-center text-green-200 text-xs mt-2">
                            ‚ö†Ô∏è Trong production th·∫≠t c·∫ßn t√≠ch h·ª£p Payment Gateway h·ª£p ph√°p
                        </p>
                    </div>

                    <div class="grid md:grid-cols-3 gap-3 md:gap-4 mb-6">
                        ${[
                            { method: 'bank', label: 'Ng√¢n H√†ng', icon: 'üè¶', min: '20K' },
                            { method: 'momo', label: 'MoMo', icon: 'üì±', min: '20K' },
                            { method: 'card', label: 'Th·∫ª C√†o', icon: 'üé´', min: '10K' }
                        ].map(item => `
                            <button
                                onclick="showWithdrawForm('${item.method}')"
                                class="bg-gradient-to-br from-green-900/50 to-emerald-900/50 rounded-xl p-4 md:p-6 border-2 border-green-500/30 hover:border-green-400 hover:scale-105 transition-all"
                            >
                                <div class="text-4xl md:text-5xl mb-2">${item.icon}</div>
                                <h3 class="font-bold">${item.label}</h3>
                                <p class="text-sm text-green-300">Min: ${item.min}</p>
                            </button>
                        `).join('')}
                    </div>

                    <div id="withdrawForm" class="hidden"></div>
                </div>
            `;
        }

        async function renderWithdrawHistoryView() {
            const userRequests = await DB.getUserWithdrawRequests(gameState.currentUsername);
            
            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                        üìú L·ªäCH S·ª¨ R√öT TI·ªÄN
                    </h2>
                    
                    <div class="space-y-4">
                        ${userRequests.length === 0 ? `
                            <div class="bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-xl p-8 border-2 border-purple-500/30 text-center">
                                <div class="text-6xl mb-4">üì≠</div>
                                <p class="text-purple-300">Ch∆∞a c√≥ l·ªãch s·ª≠ r√∫t ti·ªÅn</p>
                            </div>
                        ` : userRequests.map(req => `
                            <div class="bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-xl p-4 md:p-6 border-2 border-purple-500/30">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="font-bold text-lg">
                                            ${req.method === 'bank' ? 'üè¶ Ng√¢n H√†ng' : req.method === 'momo' ? 'üì± MoMo' : 'üé´ Th·∫ª C√†o'}
                                        </div>
                                        <div class="text-sm text-purple-300">${req.date}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-yellow-400 text-xl">${req.amount.toLocaleString()}ƒë</div>
                                        <div class="text-xs px-2 py-1 rounded-full ${
                                            req.status === 'approved' ? 'bg-green-900/50 text-green-300' :
                                            req.status === 'rejected' ? 'bg-red-900/50 text-red-300' :
                                            'bg-yellow-900/50 text-yellow-300'
                                        }">
                                            ${req.status === 'approved' ? '‚úÖ ƒê√£ duy·ªát' : req.status === 'rejected' ? '‚ùå T·ª´ ch·ªëi' : '‚è≥ Ch·ªù x·ª≠ l√Ω'}
                                        </div>
                                    </div>
                                </div>
                                
                                ${req.method === 'bank' ? `
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div class="bg-black/30 p-2 rounded">
                                            <div class="text-purple-300">Ng√¢n h√†ng:</div>
                                            <div class="font-bold">${req.details.bankName}</div>
                                        </div>
                                        <div class="bg-black/30 p-2 rounded">
                                            <div class="text-purple-300">STK:</div>
                                            <div class="font-bold">${req.details.account}</div>
                                        </div>
                                        <div class="bg-black/30 p-2 rounded col-span-2">
                                            <div class="text-purple-300">Ch·ªß TK:</div>
                                            <div class="font-bold">${req.details.owner}</div>
                                        </div>
                                    </div>
                                ` : req.method === 'momo' ? `
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div class="bg-black/30 p-2 rounded">
                                            <div class="text-purple-300">SƒêT:</div>
                                            <div class="font-bold">${req.details.phone}</div>
                                        </div>
                                        <div class="bg-black/30 p-2 rounded">
                                            <div class="text-purple-300">T√™n:</div>
                                            <div class="font-bold">${req.details.owner}</div>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-black/30 p-3 rounded">
                                        ${req.cardCode && req.status === 'approved' ? `
                                            <div class="text-sm text-purple-300 mb-1">M√£ th·∫ª:</div>
                                            <div class="font-mono font-bold text-lg text-green-400 mb-2">${req.cardCode}</div>
                                            <div class="text-xs text-yellow-200">
                                                ‚ö†Ô∏è Vui l√≤ng sao ch√©p m√£ v√† n·∫°p trong 30 ng√†y
                                            </div>
                                        ` : `
                                            <div class="text-yellow-300">‚è≥ ƒêang ch·ªù admin duy·ªát...</div>
                                        `}
                                    </div>
                                `}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function renderAdminView() {
            const allUsers = await DB.getAllUsers();
            const allRequests = await DB.getAllWithdrawRequests();
            const allListings = await DB.getAllMarketListings();
            const allAdmins = await DB.getAllAdmins();
            const pendingRequests = allRequests.filter(r => r.status === 'pending');

            return `
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center bg-gradient-to-r from-red-400 to-orange-500 bg-clip-text text-transparent">
                        üëë ADMIN PANEL - FIREBASE REALTIME
                    </h2>

                    <!-- Stats Overview -->
                    <div class="grid md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-900/50 to-cyan-900/50 rounded-xl p-4 border-2 border-blue-500/30">
                            <div class="text-3xl mb-2">üë•</div>
                            <div class="text-sm text-blue-300">T·ªïng User</div>
                            <div class="text-2xl font-bold">${Object.keys(allUsers).length}</div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-900/50 to-orange-900/50 rounded-xl p-4 border-2 border-yellow-500/30">
                            <div class="text-3xl mb-2">‚è≥</div>
                            <div class="text-sm text-yellow-300">Y√™u c·∫ßu ch·ªù</div>
                            <div class="text-2xl font-bold">${pendingRequests.length}</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-900/50 to-emerald-900/50 rounded-xl p-4 border-2 border-green-500/30">
                            <div class="text-3xl mb-2">üè™</div>
                            <div class="text-sm text-green-300">ƒê·ªì tr√™n ch·ª£</div>
                            <div class="text-2xl font-bold">${allListings.length}</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-900/50 to-pink-900/50 rounded-xl p-4 border-2 border-purple-500/30">
                            <div class="text-3xl mb-2">üìä</div>
                            <div class="text-sm text-purple-300">T·ªïng Admin</div>
                            <div class="text-2xl font-bold">${allAdmins.length}</div>
                        </div>
                    </div>

                    <!-- Admin Tools -->
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <button
                            onclick="showModifyGoldForm()"
                            class="bg-gradient-to-br from-green-900/50 to-emerald-900/50 rounded-xl p-6 border-2 border-green-500/30 hover:border-green-400 hover:scale-105 transition-all"
                        >
                            <div class="text-5xl mb-2">üí∞</div>
                            <h3 class="text-xl font-bold">C·ªòNG/TR·ª™ TI·ªÄN</h3>
                            <p class="text-sm text-green-300 mt-2">Qu·∫£n l√Ω v√†ng c·ªßa user</p>
                        </button>

                        <button
                            onclick="showSendNotificationForm()"
                            class="bg-gradient-to-br from-blue-900/50 to-cyan-900/50 rounded-xl p-6 border-2 border-blue-500/30 hover:border-blue-400 hover:scale-105 transition-all"
                        >
                            <div class="text-5xl mb-2">üì¢</div>
                            <h3 class="text-xl font-bold">TH√îNG B√ÅO SERVER</h3>
                            <p class="text-sm text-blue-300 mt-2">G·ª≠i th√¥ng b√°o to√†n h·ªá th·ªëng</p>
                        </button>
                    </div>

                    <!-- Admin Management -->
                    <div class="bg-gradient-to-br from-red-900/50 to-orange-900/50 rounded-xl p-6 border-2 border-red-500/30 mb-6">
                        <h3 class="text-xl font-bold mb-4">üëë QU·∫¢N L√ù ADMIN</h3>
                        <div class="space-y-3">
                            ${allAdmins.map(admin => `
                                <div class="bg-black/30 p-4 rounded-lg flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-lg">
                                            ${admin} 
                                            ${DB.isMasterAdmin(admin) ? '<span class="text-yellow-400 text-sm">(Master Admin - Kh√¥ng th·ªÉ g·ª°)</span>' : ''}
                                        </div>
                                        <div class="text-sm text-purple-300">Quy·ªÅn: Qu·∫£n l√Ω to√†n h·ªá th·ªëng</div>
                                    </div>
                                    ${!DB.isMasterAdmin(admin) ? `
                                        <button
                                            onclick="removeAdminUser('${admin}')"
                                            class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-sm"
                                        >
                                            G·ª° Admin
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                            
                            <button
                                onclick="addAdminUser()"
                                class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-bold"
                            >
                                ‚ûï TH√äM ADMIN M·ªöI
                            </button>
                        </div>
                    </div>

                    <!-- Withdraw Requests -->
                    <div class="bg-gradient-to-br from-purple-900/50 to-blue-900/50 rounded-xl p-6 border-2 border-purple-500/30">
                        <h3 class="text-xl font-bold mb-4">üíµ Y√äU C·∫¶U R√öT TI·ªÄN</h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${allRequests.length === 0 ? `
                                <p class="text-center text-purple-300 py-8">Ch∆∞a c√≥ y√™u c·∫ßu n√†o</p>
                            ` : allRequests.map(req => `
                                <div class="bg-black/30 p-4 rounded-lg border border-purple-500/30">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <div class="font-bold">
                                                ${req.method === 'bank' ? 'üè¶' : req.method === 'momo' ? 'üì±' : 'üé´'} 
                                                ${req.username}
                                            </div>
                                            <div class="text-sm text-purple-300">${req.date}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-yellow-400 text-lg">${req.amount.toLocaleString()}ƒë</div>
                                            <div class="text-xs px-2 py-1 rounded-full ${
                                                req.status === 'approved' ? 'bg-green-900/50 text-green-300' :
                                                req.status === 'rejected' ? 'bg-red-900/50 text-red-300' :
                                                'bg-yellow-900/50 text-yellow-300'
                                            }">
                                                ${req.status === 'approved' ? '‚úÖ ƒê√£ duy·ªát' : req.status === 'rejected' ? '‚ùå T·ª´ ch·ªëi' : '‚è≥ Ch·ªù'}
                                            </div>
                                        </div>
                                    </div>

                                    ${req.method === 'bank' ? `
                                        <div class="text-sm mb-3">
                                            <div>‚Ä¢ ${req.details.bankName}</div>
                                            <div>‚Ä¢ STK: ${req.details.account}</div>
                                            <div>‚Ä¢ T√™n: ${req.details.owner}</div>
                                        </div>
                                    ` : req.method === 'momo' ? `
                                        <div class="text-sm mb-3">
                                            <div>‚Ä¢ SƒêT: ${req.details.phone}</div>
                                            <div>‚Ä¢ T√™n: ${req.details.owner}</div>
                                        </div>
                                    ` : `
                                        <div class="text-sm mb-3">
                                            <div>‚Ä¢ M·ªánh gi√°: ${req.amount.toLocaleString()}ƒë</div>
                                            ${req.cardCode ? `<div>‚Ä¢ M√£: ${req.cardCode}</div>` : ''}
                                        </div>
                                    `}

                                    ${req.status === 'pending' ? `
                                        <div class="flex gap-2">
                                            <button
                                                onclick="approveWithdraw(${req.id})"
                                                class="flex-1 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-bold text-sm"
                                            >
                                                ‚úÖ Duy·ªát
                                            </button>
                                            <button
                                                onclick="rejectWithdraw(${req.id})"
                                                class="flex-1 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-sm"
                                            >
                                                ‚ùå T·ª´ ch·ªëi
                                            </button>
                                            <button
                                                onclick="deleteWithdraw(${req.id})"
                                                class="px-3 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold text-sm"
                                            >
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    ` : `
                                        <button
                                            onclick="deleteWithdraw(${req.id})"
                                            class="w-full py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-bold text-sm"
                                        >
                                            üóëÔ∏è X√≥a
                                        </button>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== SUPPORT MODAL ====================
        function renderSupportModal() {
            if (!gameState.showSupport) return '';

            return `
                <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onclick="toggleSupport()">
                    <div class="bg-gradient-to-br from-purple-900/95 to-blue-900/95 rounded-2xl p-6 md:p-8 max-w-md w-full border-2 border-purple-500/50 shadow-2xl slide-in" onclick="event.stopPropagation()">
                        <div class="text-center">
                            <div class="text-6xl mb-4">üí¨</div>
                            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-yellow-400 to-pink-500 bg-clip-text text-transparent">
                                H·ªñ TR·ª¢ NG∆Ø·ªúI CH∆†I
                            </h2>
                            
                            <div class="bg-black/30 rounded-xl p-4 mb-6">
                                <p class="text-purple-300 mb-4">
                                    G·∫∑p l·ªói ho·∫∑c c·∫ßn h·ªó tr·ª£?<br/>
                                    Li√™n h·ªá ngay v·ªõi ch√∫ng t√¥i qua Telegram:
                                </p>
                                <a 
                                    href="https://t.me/NQ_CTV" 
                                    target="_blank"
                                    class="inline-flex items-center gap-2 bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 px-6 py-3 rounded-xl font-bold text-lg transform hover:scale-105 transition-all"
                                >
                                    <span class="text-2xl">üì±</span>
                                    @NQ_CTV
                                </a>
                            </div>

                            <div class="text-sm text-purple-300 space-y-2">
                                <p>üìù H·ªó tr·ª£ c√°c v·∫•n ƒë·ªÅ:</p>
                                <ul class="text-left text-xs space-y-1 ml-6">
                                    <li>‚Ä¢ L·ªói game, bug k·ªπ thu·∫≠t</li>
                                    <li>‚Ä¢ V·∫•n ƒë·ªÅ r√∫t ti·ªÅn</li>
                                    <li>‚Ä¢ Khi·∫øu n·∫°i giao d·ªãch</li>
                                    <li>‚Ä¢ C√¢u h·ªèi v·ªÅ t√≠nh nƒÉng</li>
                                </ul>
                            </div>

                            <button
                                onclick="toggleSupport()"
                                class="mt-6 w-full py-3 bg-gray-600 hover:bg-gray-700 rounded-xl font-bold"
                            >
                                ‚ùå ƒê√ìNG
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== MAIN RENDER ====================
        async function render() {
            const root = document.getElementById('root');
            
            if (!gameState.isLoggedIn) {
                root.innerHTML = renderAuthScreen();
                return;
            }

            const stats = getTotalStats();
            const isAdmin = await DB.isAdmin(gameState.currentUsername);

            let viewContent = '';
            if (gameState.currentView === 'game') {
                viewContent = renderGameView();
            } else if (gameState.currentView === 'upgrade') {
                viewContent = renderUpgradeView();
            } else if (gameState.currentView === 'shop') {
                viewContent = renderShopView();
            } else if (gameState.currentView === 'boss') {
                viewContent = renderBossView();
            } else if (gameState.currentView === 'ads') {
                viewContent = renderAdsView();
            } else if (gameState.currentView === 'market') {
                viewContent = await renderMarketView();
            } else if (gameState.currentView === 'withdraw') {
                viewContent = renderWithdrawView();
            } else if (gameState.currentView === 'withdraw-history') {
                viewContent = await renderWithdrawHistoryView();
            } else if (gameState.currentView === 'admin' && isAdmin) {
                viewContent = await renderAdminView();
            }

            root.innerHTML = `
                ${renderNotificationBanner()}
                <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-purple-900/80 to-blue-900/80 backdrop-blur-lg border-b-2 border-purple-500/30 shadow-xl ${gameState.currentNotification ? 'mt-16' : ''}">
                        <div class="max-w-7xl mx-auto px-3 md:px-4 py-3 md:py-4">
                            <div class="flex items-center justify-between flex-wrap gap-3 md:gap-4">
                                <div>
                                    <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-yellow-400 to-pink-500 bg-clip-text text-transparent">
                                        üë§ ${gameState.player.name} ${isAdmin ? 'üëë' : ''}
                                    </h1>
                                    <p class="text-xs md:text-sm text-purple-300">Level ${gameState.player.level} ‚Ä¢ ·∫¢i ${gameState.player.currentStage}</p>
                                </div>
                                
                                <div class="flex gap-2 md:gap-4 flex-wrap items-center">
                                    <div class="bg-black/30 px-3 md:px-4 py-2 rounded-lg border border-yellow-500/30">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xl md:text-2xl">üí∞</span>
                                            <span class="font-bold text-yellow-400 text-sm md:text-base">${gameState.player.gold.toLocaleString()}ƒë</span>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-black/30 px-3 md:px-4 py-2 rounded-lg border border-blue-500/30">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm md:text-base">‚≠ê</span>
                                            <span class="font-bold text-sm md:text-base">${gameState.player.exp}/${gameState.player.level * 100}</span>
                                        </div>
                                    </div>

                                    <button
                                        onclick="toggleSupport()"
                                        class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-xs md:text-sm"
                                    >
                                        üí¨ H·ªó tr·ª£
                                    </button>

                                    <button
                                        onclick="handleLogout()"
                                        class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-xs md:text-sm"
                                    >
                                        üö™ ƒêƒÉng xu·∫•t
                                    </button>
                                </div>
                            </div>

                            <!-- Stats Bar -->
                            <div class="mt-3 md:mt-4 grid grid-cols-2 md:grid-cols-4 gap-2">
                                <div class="bg-red-900/30 px-2 md:px-3 py-2 rounded-lg border border-red-500/30">
                                    <div class="flex items-center justify-between text-xs md:text-sm">
                                        <span>‚ù§Ô∏è</span>
                                        <span class="font-bold">${gameState.player.hp}/${stats.totalHp}</span>
                                    </div>
                                </div>
                                <div class="bg-orange-900/30 px-2 md:px-3 py-2 rounded-lg border border-orange-500/30">
                                    <div class="flex items-center justify-between text-xs md:text-sm">
                                        <span>‚öîÔ∏è</span>
                                        <span class="font-bold">ATK: ${stats.totalAtk}</span>
                                    </div>
                                </div>
                                <div class="bg-blue-900/30 px-2 md:px-3 py-2 rounded-lg border border-blue-500/30">
                                    <div class="flex items-center justify-between text-xs md:text-sm">
                                        <span>üõ°Ô∏è</span>
                                        <span class="font-bold">DEF: ${stats.totalDef}</span>
                                    </div>
                                </div>
                                <div class="bg-yellow-900/30 px-2 md:px-3 py-2 rounded-lg border border-yellow-500/30">
                                    <div class="flex items-center justify-between text-xs md:text-sm">
                                        <span>‚ö°</span>
                                        <span class="font-bold">CRIT: ${stats.totalCrit}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="bg-black/30 border-b border-purple-500/30 sticky top-0 z-10">
                        <div class="max-w-7xl mx-auto px-2 md:px-4">
                            <div class="flex gap-1 md:gap-2 overflow-x-auto py-2 scrollbar-hide">
                                ${[
                                    { id: 'game', label: '‚öîÔ∏è Chi·∫øn ƒê·∫•u', short: '‚öîÔ∏è', admin: false },
                                    { id: 'upgrade', label: '‚¨ÜÔ∏è N√¢ng C·∫•p', short: '‚¨ÜÔ∏è', admin: false },
                                    { id: 'shop', label: 'üõí C·ª≠a H√†ng', short: 'üõí', admin: false },
                                    { id: 'boss', label: 'üëë Boss', short: 'üëë', admin: false },
                                    { id: 'ads', label: 'üì∫ Qu·∫£ng C√°o', short: 'üì∫', admin: false },
                                    { id: 'market', label: 'üè™ Ch·ª£', short: 'üè™', admin: false },
                                    { id: 'withdraw', label: 'üíµ R√∫t Ti·ªÅn', short: 'üíµ', admin: false },
                                    { id: 'withdraw-history', label: 'üìú L·ªãch S·ª≠', short: 'üìú', admin: false },
                                    { id: 'admin', label: 'üëë Admin', short: 'üëë', admin: true },
                                ].filter(nav => !nav.admin || isAdmin).map(nav => `
                                    <button
                                        onclick="gameState.currentView = '${nav.id}'; render();"
                                        class="px-2 md:px-4 py-2 rounded-lg font-bold whitespace-nowrap transition-all text-xs md:text-sm ${
                                            gameState.currentView === nav.id
                                                ? 'bg-gradient-to-r from-pink-500 to-purple-600 shadow-lg'
                                                : 'bg-purple-800/30 hover:bg-purple-700/50'
                                        }"
                                    >
                                        <span class="md:hidden">${nav.short}</span>
                                        <span class="hidden md:inline">${nav.label}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="max-w-7xl mx-auto px-3 md:px-4 py-4 md:py-6">
                        ${viewContent}
                    </div>

                    <!-- Footer -->
                    <div class="bg-black/50 border-t border-purple-500/30 mt-8 py-4">
                        <p class="text-center text-purple-300 text-xs md:text-sm">
                            ‚öîÔ∏è GAME RPG ONLINE ‚Ä¢ Made with Duc Quyet Development
                        </p>
                        <p class="text-center text-purple-400 text-xs mt-1">
                            H·ªó tr·ª£: <a href="https://t.me/NQ_CTV" target="_blank" class="text-blue-400 hover:text-blue-300 underline">@NQ_CTV</a>
                        </p>
                    </div>

                    ${renderSupportModal()}
                </div>
            `;
        }

        // ==================== INITIALIZATION ====================
        async function init() {
            const savedUser = localStorage.getItem('rpg_session_user');
            const savedPass = localStorage.getItem('rpg_session_pass');
        
            if (savedUser && savedPass) {
                console.log('üîÑ T√¨m th·∫•y session, ƒëang t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p...');
                const result = await DB.loginUser(savedUser, savedPass);
        
                if (result.success) {
                    gameState.isLoggedIn = true;
                    gameState.currentUsername = savedUser;
                    gameState.player = result.userData;
                    gameState.authError = '';
        
                    let needSave = false;
        
                    if (!gameState.player.ownedWeapons) {
                        gameState.player.ownedWeapons = [];
                        needSave = true;
                    }
                    if (!gameState.player.ownedArmors) {
                        gameState.player.ownedArmors = [];
                        needSave = true;
                    }
                    if (!gameState.player.ownedPets) {
                        gameState.player.ownedPets = [];
                        needSave = true;
                    }
                    if (!gameState.player.dailyBosses) {
                        gameState.player.dailyBosses = 2;
                        gameState.player.lastDailyReset = Date.now();
                        needSave = true;
                    }
                    if (!gameState.player.weeklyBosses) {
                        gameState.player.weeklyBosses = 3;
                        gameState.player.lastWeeklyReset = Date.now();
                        needSave = true;
                    }
        
                    // Sync HP ƒë√∫ng sau khi player ƒë√£ load
                    const stats = getTotalStats();
                    if (gameState.player.hp < stats.totalHp && !gameState.isInBattle) {
                        gameState.player.hp = stats.totalHp;
                        needSave = true;
                    }
        
                    if (needSave) {
                        await saveGame();
                    }
        
                    db.ref('users/' + savedUser + '/playerData').on('value', (snapshot) => {
                        if (snapshot.exists()) {
                            gameState.player = snapshot.val();
                            render();
                        }
                    });
        
                    checkNotifications();
        
                    setTimeout(() => {
                        if (!gameState.isInBattle && gameState.currentView === 'game') {
                            startBattle();
                        }
                    }, 500);
        
                    console.log('‚úÖ T·ª± ƒë·ªông ƒëƒÉng nh·∫≠p th√†nh c√¥ng!');
                } else {
                    console.log('‚ùå Session kh√¥ng h·ª£p l·ªá, x√≥a session');
                    localStorage.removeItem('rpg_session_user');
                    localStorage.removeItem('rpg_session_pass');
                }
            }
        
            // Reset boss h√†ng ng√†y / h√†ng tu·∫ßn
            setInterval(() => {
                if (!gameState.player) return;
                const now = Date.now();
                const dayMs = 24 * 60 * 60 * 1000;
                const weekMs = 7 * dayMs;
                let updated = false;
        
                if (now - gameState.player.lastDailyReset > dayMs) {
                    gameState.player.dailyBosses = 2;
                    gameState.player.lastDailyReset = now;
                    updated = true;
                }
                if (now - gameState.player.lastWeeklyReset > weekMs) {
                    gameState.player.weeklyBosses = 3;
                    gameState.player.lastWeeklyReset = now;
                    updated = true;
                }
                if (updated) {
                    saveGame();
                    render();
                }
            }, 60000);
        
            // Ki·ªÉm tra notification m·ªõi
            setInterval(() => {
                if (gameState.isLoggedIn && !gameState.currentNotification) {
                    checkNotifications();
                }
            }, 30000);
        
            // Ki·ªÉm tra buff h·∫øt h·∫°n m·ªói 10 gi√¢y
            setInterval(() => {
                const now = Date.now();
                let needUpdate = false;
                ['hp', 'atk', 'def'].forEach(type => {
                    if (gameState.adBoosts[type].active && now >= gameState.adBoosts[type].endTime) {
                        gameState.adBoosts[type].active = false;
                        if (type === 'hp' && gameState.player) {
                            const stats = getTotalStats();
                            if (gameState.player.hp > stats.totalHp) {
                                gameState.player.hp = stats.totalHp;
                                saveGame();
                            }
                        }
                        needUpdate = true;
                    }
                });
                if (needUpdate) render();
            }, 10000);
        
            render();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
