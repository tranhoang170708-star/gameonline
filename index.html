<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chi·∫øn Binh Huy·ªÅn Tho·∫°i - RPG Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff9f1c; /* Cam v√†ng */
            --bg: #1a1a2e; /* Xanh ƒëen t·ªëi */
            --panel: #16213e; /* Panel t·ªëi */
            --accent: #e94560; /* ƒê·ªè h·ªìng */
            --text: #ffffff;
            --success: #2ec4b6;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        #login-screen input {
            padding: 15px;
            font-size: 18px;
            width: 80%;
            border-radius: 10px;
            border: 2px solid var(--primary);
            background: #0f3460;
            color: white;
            margin-bottom: 20px;
        }

        /* --- Main UI --- */
        .header {
            background: var(--panel);
            padding: 10px;
            border-bottom: 2px solid var(--accent);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 100;
        }
        .header div { font-weight: bold; }
        .currency { color: var(--primary); font-size: 16px; grid-column: span 2; text-align: center; margin-top: 5px; }

        /* --- Battle Area --- */
        .battle-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: radial-gradient(circle at center, #252540 0%, #1a1a2e 100%);
            overflow: hidden;
        }

        .enemy-container {
            position: relative;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .enemy-container:active { transform: scale(0.95); }
        .enemy-img { font-size: 100px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
        
        .hp-bar-box {
            width: 70%; height: 20px; background: #333;
            border-radius: 10px; margin-top: 15px; border: 2px solid #fff;
            position: relative; overflow: hidden;
        }
        .hp-fill {
            height: 100%; background: var(--accent); width: 100%;
            transition: width 0.2s ease-out;
        }
        .stage-info {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; font-size: 12px;
        }

        /* --- Damage Numbers --- */
        .dmg-popup {
            position: absolute; font-weight: bold; font-size: 24px;
            color: white; animation: floatUp 0.8s forwards; pointer-events: none;
            text-shadow: 2px 2px 0 #000;
        }
        .crit { color: #ffff00; font-size: 32px; text-shadow: 0 0 10px red; }
        @keyframes floatUp { to { transform: translateY(-80px); opacity: 0; } }

        /* --- Footer Navigation --- */
        .footer-nav {
            background: var(--panel);
            display: flex;
            overflow-x: auto;
            border-top: 1px solid #333;
            padding-bottom: 5px;
        }
        .nav-btn {
            flex: 1; min-width: 70px;
            padding: 10px 5px;
            background: none; border: none;
            color: #888; font-size: 12px;
            display: flex; flex-direction: column; align-items: center;
        }
        .nav-btn i { font-size: 20px; margin-bottom: 5px; }
        .nav-btn.active { color: var(--primary); background: rgba(255,255,255,0.05); }

        /* --- Panels (Tabs) --- */
        .panel-content {
            position: absolute;
            top: 75px; bottom: 60px; left: 0; width: 100%;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(5px);
            z-index: 50;
            display: none;
            overflow-y: auto;
            padding: 15px;
        }
        .panel-content.active { display: block; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        h2 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px; margin-top: 0; }
        
        /* --- Items & Buttons --- */
        .item-row {
            background: #233050; margin-bottom: 10px; padding: 10px;
            border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #30475e;
        }
        .btn {
            background: var(--accent); color: white; border: none;
            padding: 8px 12px; border-radius: 5px; font-weight: bold; cursor: pointer;
        }
        .btn-green { background: var(--success); }
        .btn-blue { background: #007bff; }
        .btn:disabled { background: #555; opacity: 0.7; }
        
        .ad-timer { font-size: 12px; color: #aaa; margin-top: 5px; }
        
        /* --- Withdraw & History --- */
        .history-item { font-size: 12px; border-bottom: 1px dashed #555; padding: 5px 0; }
        input, select { width: 100%; padding: 10px; background: #0f3460; border: 1px solid #444; color: white; margin: 5px 0; border-radius: 5px; }

    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color: var(--primary); text-shadow: 0 0 10px orange;">GAME ONLINE</h1>
        <p>Nh·∫≠p t√™n nh√¢n v·∫≠t (T·ªëi thi·ªÉu 5 k√Ω t·ª±)</p>
        <input type="text" id="player-name-input" placeholder="V√≠ d·ª•: Player123">
        <button class="btn btn-green" style="width: 80%; padding: 15px;" onclick="startGame()">B·∫ÆT ƒê·∫¶U PHI√äU L∆ØU</button>
    </div>

    <div class="header">
        <div>üë§ <span id="ui-name">Player</span></div>
        <div style="text-align: right;">‚ù§Ô∏è <span id="ui-hp">100</span>/<span id="ui-maxhp">100</span></div>
        <div>‚öîÔ∏è <span id="ui-atk">2</span> | üéØ <span id="ui-crit">5</span>%</div>
        <div style="text-align: right;">üõ°Ô∏è <span id="ui-def">0</span></div>
        <div class="currency">üí∞ <span id="ui-coin">0</span> ƒê</div>
    </div>

    <div id="buff-bar" style="background: #333; padding: 5px; font-size: 11px; text-align: center; color: #0f0; display:none;">
        üî• ƒêang c√≥ Buff Qu·∫£ng C√°o!
    </div>

    <div class="battle-area" id="battle-area">
        <div class="stage-info">·∫¢i: <span id="ui-stage">1</span> | Qu√°i: <span id="ui-mob-count">1</span>/10</div>
        
        <div class="enemy-container" onclick="playerAttack(event)">
            <div class="enemy-img" id="enemy-sprite">üëæ</div>
        </div>

        <h3 id="enemy-name" style="margin-bottom: 5px;">Qu√°i Th∆∞·ªùng</h3>
        <div class="hp-bar-box">
            <div class="hp-fill" id="enemy-hp-bar"></div>
        </div>
        <div style="margin-top: 5px;"><span id="enemy-hp">100</span> HP</div>
    </div>

    <div id="tab-upgrade" class="panel-content">
        <h2>‚¨ÜÔ∏è N√¢ng C·∫•p Nh√¢n V·∫≠t</h2>
        <div class="item-row">
            <div>
                <b>Luy·ªán Ki·∫øm (ATK)</b><br><small>TƒÉng s·ª©c t·∫•n c√¥ng</small>
            </div>
            <button class="btn" onclick="upgradeStat('atk')"><span id="cost-atk">100</span>ƒê</button>
        </div>
        <div class="item-row">
            <div>
                <b>R√®n Th·ªÉ L·ª±c (HP)</b><br><small>TƒÉng m√°u t·ªëi ƒëa</small>
            </div>
            <button class="btn" onclick="upgradeStat('hp')"><span id="cost-hp">100</span>ƒê</button>
        </div>
        <div class="item-row">
            <div>
                <b>T·∫≠p Trung (Crit)</b><br><small>TƒÉng t·ªâ l·ªá ch√≠ m·∫°ng</small>
            </div>
            <button class="btn" onclick="upgradeStat('crit')"><span id="cost-crit">200</span>ƒê</button>
        </div>
    </div>

    <div id="tab-shop" class="panel-content">
        <h2>‚öîÔ∏è Shop V≈© Kh√≠</h2>
        <div id="shop-weapon-list"></div>
        
        <h2>üõ°Ô∏è Shop Gi√°p</h2>
        <div id="shop-armor-list"></div>

        <h2>üê∂ Shop Pet</h2>
        <div id="shop-pet-list"></div>
    </div>

    <div id="tab-boss" class="panel-content">
        <h2>üíÄ SƒÉn Boss (T·ª± Ch·ªçn)</h2>
        <div class="item-row">
            <div><b>Boss Ng√†y (x5 V√†ng)</b><br><small>C√≤n l·∫°i: <span id="boss-daily-left">2</span>/2</small></div>
            <button class="btn btn-blue" onclick="summonBoss('daily')">Tri·ªáu H·ªìi</button>
        </div>
        <div class="item-row">
            <div><b>Boss Tu·∫ßn (x10 V√†ng)</b><br><small>C√≤n l·∫°i: <span id="boss-weekly-left">3</span>/3</small></div>
            <button class="btn btn-blue" onclick="summonBoss('weekly')">Tri·ªáu H·ªìi</button>
        </div>
        <button class="btn" style="width:100%; background:#444; margin-top:10px;" onclick="returnToFarm()">üè≥Ô∏è Quay l·∫°i ·∫£i th∆∞·ªùng</button>

        <h2 style="margin-top: 30px;">üé¨ Xem QC Nh·∫≠n Qu√† (Adsterra)</h2>
        <div class="item-row">
            <div><b>+100 HP (10 Ph√∫t)</b></div>
            <button class="btn btn-green" onclick="watchAd('hp')">Xem QC</button>
        </div>
        <div class="item-row">
            <div><b>+75 ATK (10 Ph√∫t)</b></div>
            <button class="btn btn-green" onclick="watchAd('atk')">Xem QC</button>
        </div>
        <div class="item-row">
            <div><b>+10 DEF (10 Ph√∫t)</b></div>
            <button class="btn btn-green" onclick="watchAd('def')">Xem QC</button>
        </div>
        <div class="item-row">
            <div><b>Nh·∫≠n 50 Coin</b></div>
            <button class="btn btn-green" onclick="watchAd('coin50')">Xem QC</button>
        </div>
        <div class="item-row">
            <div><b>Nh·∫≠n 100 Coin (2 QC)</b></div>
            <button class="btn btn-green" onclick="watchAd('coin100')">Xem QC (0/2)</button>
        </div>
    </div>

    <div id="tab-market" class="panel-content">
        <h2>üè™ Ch·ª£ ƒê·ªì (Global Market)</h2>
        <p style="font-size:12px; color:#aaa;">*B√°n l·∫°i ƒë·ªì c≈© cho ng∆∞·ªùi ch∆°i kh√°c.</p>
        <div id="market-list">
            <div style="text-align:center; padding:20px; color:#666;">ƒêang t·∫£i d·ªØ li·ªáu ch·ª£...</div>
        </div>
        <button class="btn" style="width:100%; margin-top:10px" onclick="openSellModal()">‚ûï ƒêƒÉng b√°n v·∫≠t ph·∫©m</button>

        <h2>ü§ù Trade Tr·ª±c Ti·∫øp</h2>
        <input type="text" id="trade-name" placeholder="T√™n ng∆∞·ªùi nh·∫≠n (VD: PlayerX)">
        <select id="trade-item-select"><option>Ch·ªçn v·∫≠t ph·∫©m...</option></select>
        <button class="btn btn-blue" style="width:100%; margin-top:5px;" onclick="p2pTrade()">G·ª≠i ƒë·ªì</button>
    </div>

    <div id="tab-withdraw" class="panel-content">
        <h2>üè¶ R√∫t Ti·ªÅn</h2>
        <div style="background:#0f3460; padding:10px; border-radius:5px; margin-bottom:10px;">
            S·ªë d∆∞ kh·∫£ d·ª•ng: <b style="color:yellow"><span id="w-balance">0</span> ƒê</b>
        </div>
        
        <select id="w-method" onchange="toggleWithdrawForm()">
            <option value="bank">Ng√¢n H√†ng (Min 20k)</option>
            <option value="momo">V√≠ Momo (Min 20k)</option>
            <option value="card">Th·∫ª C√†o Viettel (10k - 100k)</option>
        </select>

        <div id="form-bank" class="w-form">
            <input type="text" placeholder="T√™n Ng√¢n H√†ng (VD: MBBank)">
            <input type="text" placeholder="S·ªë T√†i Kho·∫£n">
            <input type="text" placeholder="T√™n Ng∆∞·ªùi Th·ª• H∆∞·ªüng">
        </div>
        <div id="form-momo" class="w-form" style="display:none">
            <input type="text" placeholder="S·ªë ƒêi·ªán Tho·∫°i Momo">
            <input type="text" placeholder="T√™n Ng∆∞·ªùi Th·ª• H∆∞·ªüng">
        </div>
        <div id="form-card" class="w-form" style="display:none">
            <p style="font-size:12px;">M·ªánh gi√°: 10k, 20k, 50k, 100k.</p>
        </div>

        <input type="number" id="w-amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn c·∫ßn r√∫t...">
        <button class="btn btn-green" style="width:100%; margin-top:10px; font-size:16px;" onclick="processWithdraw()">X√ÅC NH·∫¨N R√öT</button>

        <h2>üìú L·ªãch S·ª≠ R√∫t Ti·ªÅn</h2>
        <div id="w-history"></div>
    </div>

    <div class="footer-nav">
        <button class="nav-btn" onclick="showPanel(null)">
            <i class="fas fa-gamepad"></i> Battle
        </button>
        <button class="nav-btn" onclick="showPanel('tab-upgrade')">
            <i class="fas fa-arrow-up"></i> Upgrade
        </button>
        <button class="nav-btn" onclick="showPanel('tab-shop')">
            <i class="fas fa-store"></i> Shop
        </button>
        <button class="nav-btn" onclick="showPanel('tab-boss')">
            <i class="fas fa-skull"></i> Boss/Ads
        </button>
        <button class="nav-btn" onclick="showPanel('tab-market')">
            <i class="fas fa-handshake"></i> Ch·ª£
        </button>
        <button class="nav-btn" onclick="showPanel('tab-withdraw')">
            <i class="fas fa-wallet"></i> R√∫t Ti·ªÅn
        </button>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const WEAPONS = [
            {id: 'w0', name: 'Tay Kh√¥ng', val: 0, price: 0},
            {id: 'w1', name: 'Ki·∫øm G·ªó', val: 20, price: 200},
            {id: 'w2', name: 'Ki·∫øm ƒê√°', val: 35, price: 500},
            {id: 'w3', name: 'Ki·∫øm S·∫Øt', val: 50, price: 1000},
            {id: 'w4', name: 'Ki·∫øm V√†ng', val: 75, price: 2000},
            {id: 'w5', name: 'K.Kim C∆∞∆°ng', val: 125, price: 3000},
            {id: 'w6', name: 'K.C·∫ßu V·ªìng', val: 180, price: 4500},
            {id: 'w7', name: 'Ki·∫øm Th√°nh', val: 300, price: 7000}
        ];

        const ARMORS = [
            {id: 'a0', name: '√Åo R√°ch', def: 0, hp: 0, price: 0},
            {id: 'a1', name: 'Gi√°p V·∫£i', def: 3, hp: 50, price: 500},
            {id: 'a2', name: 'Gi√°p ƒê·ªìng', def: 7, hp: 75, price: 1000},
            {id: 'a3', name: 'Gi√°p S·∫Øt', def: 10, hp: 100, price: 1500},
            {id: 'a4', name: 'G.Kim C∆∞∆°ng', def: 15, hp: 150, price: 3000},
            {id: 'a5', name: 'Gi√°p Th√°nh', def: 30, hp: 300, price: 5000}
        ];

        const PETS = [
            {id: 'p0', name: 'Kh√¥ng', buff: 0, price: 0},
            {id: 'p1', name: 'G√† Con', buff: 0.05, price: 500},
            {id: 'p2', name: 'Ch√≥ Con', buff: 0.08, price: 1000},
            {id: 'p3', name: 'S√≥i X√°m', buff: 0.13, price: 1500},
            {id: 'p4', name: 'Voi Ma M√∫t', buff: 0.20, price: 2300},
            {id: 'p5', name: 'R·ªìng Th·∫ßn', buff: 0.30, price: 3500}
        ];

        let player = {
            name: "",
            coin: 0,
            baseHp: 100,
            baseAtk: 2,
            baseCrit: 5,
            weapon: 0,
            armor: 0,
            pet: 0,
            stage: 1,
            mobCount: 0,
            inventory: []
        };

        let buffs = { hp: 0, atk: 0, def: 0 };
        let enemy = { hp: 10, maxHp: 10, isBoss: false, type: 'normal' };
        
        let bossLimits = {
            daily: 2, weekly: 3, lastReset: Date.now()
        };

        let adCounter = 0; // For the "2 clicks" requirement

        // --- CORE FUNCTIONS ---

        function startGame() {
            let name = document.getElementById('player-name-input').value;
            // Validate: Min 5 chars + number check
            if (name.length < 5 || !/\d/.test(name)) {
                alert("T√™n ph·∫£i c√≥ √≠t nh·∫•t 5 k√Ω t·ª± v√† bao g·ªìm s·ªë!");
                return;
            }
            player.name = name;
            document.getElementById('login-screen').style.display = 'none';
            
            loadData();
            renderShop();
            spawnEnemy();
            updateUI();
        }

        function spawnEnemy() {
            let isBossStage = (player.mobCount >= 10);
            
            if(enemy.type === 'daily' || enemy.type === 'weekly') {
                // Keep current boss
            } else {
                enemy.isBoss = isBossStage;
                enemy.type = 'normal';
                
                // Formula for HP
                let baseHp = 20 * Math.pow(1.15, player.stage);
                enemy.maxHp = Math.floor(baseHp * (isBossStage ? 3 : 1)); 
                enemy.hp = enemy.maxHp;
                
                let sprites = ["üëæ", "üíÄ", "üëπ", "üëΩ", "ü§ñ", "üëª"];
                document.getElementById('enemy-sprite').innerText = isBossStage ? "üëø" : sprites[player.stage % 6];
                document.getElementById('enemy-name').innerText = isBossStage ? "BOSS ·∫¢I " + player.stage : "Qu√°i ·∫¢i " + player.stage;
            }
            updateHpBar();
        }

        function playerAttack(e) {
            // Calculate Stats
            let wp = WEAPONS[player.weapon];
            let am = ARMORS[player.armor];
            let pt = PETS[player.pet];

            let totalAtk = (player.baseAtk + wp.val + buffs.atk) * (1 + pt.buff);
            let isCrit = Math.random() * 100 < player.baseCrit;
            if(isCrit) totalAtk *= 2;
            
            totalAtk = Math.floor(totalAtk);
            enemy.hp -= totalAtk;

            // Visuals
            createDamagePopup(totalAtk, isCrit, e);
            document.getElementById('enemy-sprite').style.transform = "scale(0.8)";
            setTimeout(()=> document.getElementById('enemy-sprite').style.transform = "scale(1)", 100);

            if(enemy.hp <= 0) {
                winBattle();
            }
            updateHpBar();
        }

        function winBattle() {
            // Reward
            let gold = Math.floor(5 * Math.pow(1.1, player.stage)); // Base gold
            
            if(enemy.type === 'daily') {
                gold *= 5;
                alert("ƒê√£ di·ªát Boss Ng√†y! +"+gold+"ƒê");
                returnToFarm();
            } else if (enemy.type === 'weekly') {
                gold *= 10;
                alert("ƒê√£ di·ªát Boss Tu·∫ßn! +"+gold+"ƒê");
                returnToFarm();
            } else if (enemy.isBoss) {
                // Normal Boss
                gold *= 2;
                player.stage++;
                player.mobCount = 0;
            } else {
                // Normal Mob
                player.mobCount++;
            }

            player.coin += gold;
            spawnEnemy();
            updateUI();
        }

        function summonBoss(type) {
            checkBossReset();
            
            if(type === 'daily') {
                if(bossLimits.daily > 0) {
                    bossLimits.daily--;
                    setupBossBattle("BOSS NG√ÄY", 5); // x5 strength
                    enemy.type = 'daily';
                } else alert("H·∫øt l∆∞·ª£t Boss ng√†y!");
            } else {
                if(bossLimits.weekly > 0) {
                    bossLimits.weekly--;
                    setupBossBattle("BOSS TU·∫¶N", 10); // x10 strength
                    enemy.type = 'weekly';
                } else alert("H·∫øt l∆∞·ª£t Boss tu·∫ßn!");
            }
            showPanel(null); // Close panel
        }

        function setupBossBattle(name, multiplier) {
            let baseHp = 20 * Math.pow(1.15, player.stage);
            enemy.maxHp = Math.floor(baseHp * 10 * multiplier);
            enemy.hp = enemy.maxHp;
            enemy.isBoss = true;
            document.getElementById('enemy-sprite').innerText = "üê≤";
            document.getElementById('enemy-name').innerText = name;
            updateHpBar();
        }

        function returnToFarm() {
            enemy.type = 'normal';
            spawnEnemy();
        }

        function checkBossReset() {
            let now = new Date();
            let last = new Date(bossLimits.lastReset);
            if(now.getDate() !== last.getDate()) {
                bossLimits.daily = 2;
                // Simple weekly reset logic (if monday)
                if(now.getDay() === 1) bossLimits.weekly = 3;
                bossLimits.lastReset = Date.now();
            }
        }

        // --- SHOP & UPGRADE ---
        
        function upgradeStat(type) {
            let cost = 0;
            if(type === 'atk') {
                cost = 100 + player.baseAtk * 10;
                if(player.coin >= cost) {
                    player.coin -= cost;
                    player.baseAtk += 2;
                    updateUI();
                }
            } else if (type === 'hp') {
                cost = 100 + (player.baseHp - 100);
                if(player.coin >= cost) {
                    player.coin -= cost;
                    player.baseHp += 20;
                    updateUI();
                }
            } else if (type === 'crit') {
                cost = 200 + player.baseCrit * 50;
                if(player.coin >= cost) {
                    player.coin -= cost;
                    player.baseCrit += 1;
                    updateUI();
                }
            }
        }

        function renderShop() {
            // Weapons
            let wHtml = "";
            WEAPONS.forEach((w, idx) => {
                if(idx === 0) return;
                let owned = player.weapon >= idx;
                let btn = owned ? `<button class="btn" disabled>ƒê√£ Mua</button>` : 
                          `<button class="btn" onclick="buyItem('weapon', ${idx})">Mua ${w.price}ƒê</button>`;
                if(player.weapon === idx) btn = `<button class="btn btn-green">ƒêang ƒêeo</button>`;
                
                wHtml += `<div class="item-row"><div><b>${w.name}</b><br><small>+${w.val} Dame</small></div>${btn}</div>`;
            });
            document.getElementById('shop-weapon-list').innerHTML = wHtml;

            // Armors
            let aHtml = "";
            ARMORS.forEach((a, idx) => {
                if(idx === 0) return;
                let owned = player.armor >= idx;
                let btn = owned ? `<button class="btn" disabled>ƒê√£ Mua</button>` : 
                          `<button class="btn" onclick="buyItem('armor', ${idx})">Mua ${a.price}ƒê</button>`;
                
                aHtml += `<div class="item-row"><div><b>${a.name}</b><br><small>+${a.def} Def, +${a.hp} HP</small></div>${btn}</div>`;
            });
            document.getElementById('shop-armor-list').innerHTML = aHtml;
            
            // Pets
            let pHtml = "";
            PETS.forEach((p, idx) => {
                if(idx === 0) return;
                let owned = player.pet === idx; // Only own 1 active pet for simplicity
                let btn = `<button class="btn" onclick="buyItem('pet', ${idx})">Mua ${p.price}ƒê</button>`;
                if(player.pet === idx) btn = `<button class="btn btn-green">ƒêang d√πng</button>`;

                pHtml += `<div class="item-row"><div><b>${p.name}</b><br><small>+${p.buff*100}% ATK</small></div>${btn}</div>`;
            });
            document.getElementById('shop-pet-list').innerHTML = pHtml;
        }

        function buyItem(cat, id) {
            let price = 0;
            if(cat === 'weapon') price = WEAPONS[id].price;
            if(cat === 'armor') price = ARMORS[id].price;
            if(cat === 'pet') price = PETS[id].price;

            if(player.coin >= price) {
                player.coin -= price;
                if(cat === 'weapon') player.weapon = id;
                if(cat === 'armor') player.armor = id;
                if(cat === 'pet') player.pet = id;
                alert("Mua th√†nh c√¥ng!");
                updateUI();
                renderShop();
            } else {
                alert("Kh√¥ng ƒë·ªß ti·ªÅn!");
            }
        }

        // --- ADS SYSTEM ---
        function watchAd(type) {
            // Simulate Adsterra click
            let confirmed = confirm("B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang qu·∫£ng c√°o (Adsterra) ƒë·ªÉ nh·∫≠n th∆∞·ªüng?");
            if(confirmed) {
                window.open("https://adsterra.com/", "_blank");
                
                setTimeout(() => {
                    if(type === 'hp') {
                        buffs.hp = 100;
                        setTimeout(() => { buffs.hp = 0; updateUI(); }, 600000); // 10 mins
                        alert("ƒê√£ nh·∫≠n Buff +100HP trong 10 ph√∫t!");
                    } else if(type === 'atk') {
                        buffs.atk = 75;
                        setTimeout(() => { buffs.atk = 0; updateUI(); }, 600000);
                        alert("ƒê√£ nh·∫≠n Buff +75 ATK trong 10 ph√∫t!");
                    } else if(type === 'def') {
                        buffs.def = 10;
                        setTimeout(() => { buffs.def = 0; updateUI(); }, 600000);
                        alert("ƒê√£ nh·∫≠n Buff +10 DEF trong 10 ph√∫t!");
                    } else if(type === 'coin50') {
                        // Variable coin logic
                        let c = Math.floor(Math.random() * 20) + 40; // 40-60
                        player.coin += c;
                        alert("Nh·∫≠n ƒë∆∞·ª£c " + c + " Coin!");
                    } else if (type === 'coin100') {
                        adCounter++;
                        if(adCounter >= 2) {
                            let c = Math.floor(Math.random() * 50) + 80; // 80-130
                            player.coin += c;
                            alert("ƒê√£ xem 2 QC. Nh·∫≠n " + c + " Coin!");
                            adCounter = 0;
                        } else {
                            alert("ƒê√£ xem 1/2 QC. H√£y xem th√™m 1 QC n·ªØa!");
                        }
                    }
                    updateUI();
                }, 2000); // Simulate wait
            }
        }

        // --- MARKET & TRADE ---
        function openSellModal() {
            // Simplified: Sell current weapon for 50% price
            let wp = WEAPONS[player.weapon];
            if(player.weapon === 0) {
                alert("Kh√¥ng c√≥ g√¨ ƒë·ªÉ b√°n!"); return;
            }
            if(confirm(`B·∫°n c√≥ mu·ªën ƒëƒÉng b√°n ${wp.name} l√™n ch·ª£ v·ªõi gi√° ${wp.price/2}ƒê kh√¥ng? (M·∫•t v≈© kh√≠)`)) {
                player.weapon = 0;
                player.coin += (wp.price / 2); // Instant sell for simplicity in "Offline" mode
                alert("ƒê√£ b√°n th√†nh c√¥ng!");
                renderShop();
                updateUI();
            }
        }

        function p2pTrade() {
            let target = document.getElementById('trade-name').value;
            if(!target) return alert("Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n!");
            alert(`ƒê√£ g·ª≠i y√™u c·∫ßu giao d·ªãch ƒë·∫øn ${target} (Gi·∫£ l·∫≠p)`);
        }

        function loadMarket() {
            // Simulated fake market data
            let html = "";
            let randomItems = [
                {name: "Ki·∫øm G·ªó", price: 100, seller: "DragonSlayer"},
                {name: "Gi√°p V·∫£i", price: 200, seller: "NoobMaster69"},
                {name: "Ki·∫øm S·∫Øt", price: 800, seller: "ProVjpPromax"}
            ];
            randomItems.forEach(i => {
                html += `<div class="item-row"><div><b>${i.name}</b><br><small>Ng∆∞·ªùi b√°n: ${i.seller}</small></div><button class="btn btn-green" onclick="alert('ƒê√£ mua!')">Mua ${i.price}ƒê</button></div>`;
            });
            document.getElementById('market-list').innerHTML = html;
        }

        // --- WITHDRAW ---
        function toggleWithdrawForm() {
            document.querySelectorAll('.w-form').forEach(d => d.style.display = 'none');
            let val = document.getElementById('w-method').value;
            document.getElementById('form-'+val).style.display = 'block';
        }

        function processWithdraw() {
            let amount = parseInt(document.getElementById('w-amount').value);
            let method = document.getElementById('w-method').value;
            
            // Limits
            let min = 20000;
            let max = 99999999;
            if(method === 'card') { min = 10000; max = 100000; }
            
            if(!amount || amount < min) {
                alert(`R√∫t t·ªëi thi·ªÉu ${min}ƒê!`); return;
            }
            if(method === 'card' && amount > max) {
                 alert(`Th·∫ª c√†o t·ªëi ƒëa ${max}ƒê!`); return;
            }

            if(player.coin >= amount) {
                player.coin -= amount;
                
                // Add to history
                let date = new Date().toLocaleString();
                let histHtml = `<div class="history-item">
                    <b>${amount}ƒê</b> - ${method.toUpperCase()} <br>
                    <span style="color:#aaa">${date}</span> - <span style="color:yellow">ƒêang duy·ªát</span>
                    ${method === 'card' ? '<br>M√£ th·∫ª: ƒêang ch·ªù...' : ''}
                </div>`;
                
                let histContainer = document.getElementById('w-history');
                histContainer.innerHTML = histHtml + histContainer.innerHTML;

                localStorage.setItem('game_history', histContainer.innerHTML);
                alert("G·ª≠i y√™u c·∫ßu r√∫t ti·ªÅn th√†nh c√¥ng!");
                updateUI();
            } else {
                alert("S·ªë d∆∞ kh√¥ng ƒë·ªß!");
            }
        }

        // --- UTILS & UI UPDATE ---
        function updateUI() {
            let wp = WEAPONS[player.weapon];
            let am = ARMORS[player.armor];
            let pt = PETS[player.pet];

            // Stats Calc
            let realHp = player.baseHp + am.hp + buffs.hp;
            let realAtk = (player.baseAtk + wp.val + buffs.atk) * (1 + pt.buff);
            let realDef = am.def + buffs.def;

            // UI
            document.getElementById('ui-name').innerText = player.name;
            document.getElementById('ui-hp').innerText = Math.floor(realHp);
            document.getElementById('ui-maxhp').innerText = Math.floor(realHp);
            document.getElementById('ui-atk').innerText = Math.floor(realAtk);
            document.getElementById('ui-crit').innerText = player.baseCrit;
            document.getElementById('ui-def').innerText = realDef;
            document.getElementById('ui-coin').innerText = player.coin.toLocaleString();
            document.getElementById('w-balance').innerText = player.coin.toLocaleString();
            
            document.getElementById('ui-stage').innerText = player.stage;
            document.getElementById('ui-mob-count').innerText = player.mobCount;
            
            // Boss counts
            document.getElementById('boss-daily-left').innerText = bossLimits.daily;
            document.getElementById('boss-weekly-left').innerText = bossLimits.weekly;

            // Costs
            document.getElementById('cost-atk').innerText = 100 + player.baseAtk * 10;
            document.getElementById('cost-hp').innerText = 100 + (player.baseHp - 100);
            document.getElementById('cost-crit').innerText = 200 + player.baseCrit * 50;

            // Buff bar
            if(buffs.hp > 0 || buffs.atk > 0) document.getElementById('buff-bar').style.display = 'block';
            else document.getElementById('buff-bar').style.display = 'none';

            saveData();
        }

        function updateHpBar() {
            let pct = (enemy.hp / enemy.maxHp) * 100;
            if(pct < 0) pct = 0;
            document.getElementById('enemy-hp-bar').style.width = pct + "%";
            document.getElementById('enemy-hp').innerText = enemy.hp;
        }

        function createDamagePopup(dmg, isCrit, e) {
            let el = document.createElement('div');
            el.className = 'dmg-popup';
            if(isCrit) el.classList.add('crit');
            el.innerText = isCrit ? "CRIT " + dmg : dmg;
            
            let x, y;
            if(e) {
                x = e.clientX; y = e.clientY;
            } else {
                x = window.innerWidth/2; y = window.innerHeight/2;
            }
            
            el.style.left = (x - 20) + 'px';
            el.style.top = (y - 50) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function showPanel(id) {
            document.querySelectorAll('.panel-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            if(id) {
                document.getElementById(id).classList.add('active');
                event.currentTarget.classList.add('active');
                if(id === 'tab-market') loadMarket();
            }
        }

        // --- SAVE / LOAD ---
        function saveData() {
            let data = {
                player: player,
                bossLimits: bossLimits
            };
            localStorage.setItem('rpg_online_save', JSON.stringify(data));
        }

        function loadData() {
            let saved = localStorage.getItem('rpg_online_save');
            if(saved) {
                let d = JSON.parse(saved);
                player = {...player, ...d.player}; // Merge incase new fields
                bossLimits = d.bossLimits;
                // Restore history
                let hist = localStorage.getItem('game_history');
                if(hist) document.getElementById('w-history').innerHTML = hist;
            }
        }

    </script>
</body>
</html>
