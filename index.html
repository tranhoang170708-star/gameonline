<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öîÔ∏è RPG ONLINE - JSON DATABASE SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');
        * { font-family: 'Roboto', sans-serif; }
        body { margin: 0; padding: 0; overflow-x: hidden; background-color: #0f172a; color: white; }
        .btn { transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
        .glass { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <input type="file" id="importFile" style="display: none" accept=".json" onchange="DB.processImport(this)">

    <script>
        // ==================== DATABASE CORE (JSON SYSTEM) ====================
        class JSONDatabase {
            constructor() {
                this.DB_KEY = 'rpg_full_database_v2'; 
                this.CURRENT_USER_KEY = 'rpg_current_session';
                this.MASTER_ADMIN = 'Quyet170708';
                
                // Kh·ªüi t·∫°o DB n·∫øu ch∆∞a c√≥
                if (!localStorage.getItem(this.DB_KEY)) {
                    this.resetDatabase();
                }
            }

            // --- QU·∫¢N L√ù D·ªÆ LI·ªÜU C·ªêT L√ïI ---
            getDB() {
                try {
                    return JSON.parse(localStorage.getItem(this.DB_KEY));
                } catch (e) {
                    return this.resetDatabase();
                }
            }

            saveDB(data) {
                localStorage.setItem(this.DB_KEY, JSON.stringify(data));
            }

            resetDatabase() {
                const initData = {
                    users: {},
                    market: [],
                    withdraws: [],
                    admins: [this.MASTER_ADMIN],
                    notifications: []
                };
                this.saveDB(initData);
                return initData;
            }

            // --- XU·∫§T/NH·∫¨P FILE JSON (T√çNH NƒÇNG USER Y√äU C·∫¶U) ---
            exportDatabase() {
                const data = this.getDB();
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0,19).replace(/:/g,"-");
                a.download = `RPG_DATA_${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                return true;
            }

            triggerImport() {
                document.getElementById('importFile').click();
            }

            processImport(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const newData = JSON.parse(e.target.result);
                        
                        // Validate c·∫•u tr√∫c file
                        if (!newData.users || !newData.admins) {
                            alert('‚ùå File l·ªói! Kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng Game.');
                            return;
                        }

                        if (confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω GHI ƒê√à to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i b·∫±ng d·ªØ li·ªáu trong file.\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?')) {
                            this.saveDB(newData);
                            alert('‚úÖ ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu th√†nh c√¥ng! Trang s·∫Ω t·∫£i l·∫°i.');
                            location.reload();
                        }
                    } catch (err) {
                        alert('‚ùå File kh√¥ng h·ª£p l·ªá!');
                    }
                };
                reader.readAsText(file);
                input.value = ''; // Reset input
            }

            // --- USER MANAGEMENT ---
            createUser(username, password) {
                const db = this.getDB();
                if (db.users[username]) return { success: false, message: 'T√™n ƒë√£ t·ªìn t·∫°i!' };

                db.users[username] = {
                    password: password,
                    name: username,
                    gold: 0,
                    hp: 100, maxHp: 100, atk: 10, def: 0,
                    level: 1, exp: 0,
                    items: [],
                    lastLogin: Date.now()
                };
                
                this.saveDB(db);
                return { success: true, message: 'T·∫°o t√†i kho·∫£n th√†nh c√¥ng!' };
            }

            login(username, password) {
                const db = this.getDB();
                if (!db.users[username]) return { success: false, message: 'User kh√¥ng t·ªìn t·∫°i!' };
                if (db.users[username].password !== password) return { success: false, message: 'Sai m·∫≠t kh·∫©u!' };

                localStorage.setItem(this.CURRENT_USER_KEY, username);
                return { success: true, user: db.users[username] };
            }

            getCurrentUser() {
                const username = localStorage.getItem(this.CURRENT_USER_KEY);
                const db = this.getDB();
                if (username && db.users[username]) return db.users[username];
                return null;
            }

            logout() {
                localStorage.removeItem(this.CURRENT_USER_KEY);
            }

            updateUser(username, newData) {
                const db = this.getDB();
                if (db.users[username]) {
                    db.users[username] = { ...db.users[username], ...newData };
                    this.saveDB(db);
                }
            }

            // --- ADMIN FEATURES ---
            isAdmin(username) {
                const db = this.getDB();
                return db.admins.includes(username);
            }

            // ƒê√ÇY L√Ä H√ÄM QUAN TR·ªåNG ƒê·ªÇ ADMIN C·ªòNG TI·ªÄN
            adminAddGold(targetUsername, amount) {
                const db = this.getDB();
                
                // Trim ƒë·ªÉ x√≥a kho·∫£ng tr·∫Øng th·ª´a
                const cleanName = targetUsername.trim();

                if (!db.users[cleanName]) {
                    // Debug: Li·ªát k√™ danh s√°ch user hi·ªán c√≥ ƒë·ªÉ Admin bi·∫øt
                    const existingUsers = Object.keys(db.users).join(", ");
                    return { success: false, message: `‚ùå User "${cleanName}" kh√¥ng t√¨m th·∫•y!\n\nDanh s√°ch User ƒëang c√≥ trong file n√†y:\n${existingUsers}` };
                }

                db.users[cleanName].gold += parseInt(amount);
                this.saveDB(db);
                return { success: true, message: `‚úÖ ƒê√£ c·ªông ${amount} v√†ng cho ${cleanName}.\nS·ªë d∆∞ m·ªõi: ${db.users[cleanName].gold}`, newBalance: db.users[cleanName].gold };
            }
        }

        const DB = new JSONDatabase();
        let gameState = {
            view: 'login', // login, register, game, admin
            user: null
        };

        // ==================== LOGIC FUNCTIONS ====================
        function handleLogin() {
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value;
            const res = DB.login(u, p);
            if (res.success) {
                gameState.user = res.user;
                gameState.view = 'game';
                render();
            } else {
                alert(res.message);
            }
        }

        function handleRegister() {
            const u = document.getElementById('regUser').value.trim();
            const p = document.getElementById('regPass').value;
            if(!u || !p) return alert('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin');
            const res = DB.createUser(u, p);
            alert(res.message);
            if(res.success) {
                gameState.view = 'login';
                render();
            }
        }

        function handleAdminAddGold() {
            const u = document.getElementById('adminTargetUser').value;
            const a = document.getElementById('adminAmount').value;
            if (!u || !a) return alert('Nh·∫≠p thi·∫øu th√¥ng tin!');
            
            const res = DB.adminAddGold(u, a);
            alert(res.message);
            // N·∫øu admin c·ªông ti·ªÅn cho ch√≠nh m√¨nh, c·∫≠p nh·∫≠t UI ngay
            if (res.success && u === gameState.user.name) {
                gameState.user.gold = res.newBalance;
                render();
            }
        }

        // ==================== UI RENDERING ====================
        function render() {
            const root = document.getElementById('root');
            let html = '';

            // --- VIEW: LOGIN ---
            if (gameState.view === 'login') {
                html = `
                    <div class="min-h-screen flex items-center justify-center bg-[url('https://wallpaperaccess.com/full/156340.jpg')] bg-cover bg-center">
                        <div class="glass p-8 rounded-2xl w-full max-w-md shadow-2xl">
                            <h1 class="text-4xl font-black text-center mb-6 text-yellow-400 drop-shadow-md">RPG JSON</h1>
                            <div class="space-y-4">
                                <input id="loginUser" type="text" placeholder="Username" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg p-3 text-white focus:outline-none focus:border-yellow-400">
                                <input id="loginPass" type="password" placeholder="Password" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg p-3 text-white focus:outline-none focus:border-yellow-400">
                                <button onclick="handleLogin()" class="btn w-full bg-gradient-to-r from-yellow-600 to-yellow-500 py-3 rounded-lg font-bold text-lg shadow-lg">ƒêƒÇNG NH·∫¨P</button>
                                <div class="flex gap-2">
                                    <button onclick="gameState.view='register';render()" class="flex-1 text-sm text-slate-300 hover:text-white">ƒêƒÉng k√Ω m·ªõi</button>
                                    <button onclick="DB.triggerImport()" class="flex-1 text-sm text-green-400 hover:text-green-300 font-bold">üìÇ NH·∫¨P FILE DATA</button>
                                </div>
                            </div>
                            <div class="mt-6 text-xs text-center text-slate-400">
                                *Tip: N·∫øu ch∆°i kh√°c m√°y, h√£y d√πng ch·ª©c nƒÉng Nh·∫≠p File Data
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- VIEW: REGISTER ---
            else if (gameState.view === 'register') {
                html = `
                    <div class="min-h-screen flex items-center justify-center bg-slate-900">
                        <div class="glass p-8 rounded-2xl w-full max-w-md">
                            <h2 class="text-2xl font-bold mb-4 text-center">ƒêƒÇNG K√ù T√ÄI KHO·∫¢N</h2>
                            <input id="regUser" type="text" placeholder="T√™n ƒëƒÉng nh·∫≠p" class="w-full mb-3 bg-slate-800 border border-slate-600 rounded p-3">
                            <input id="regPass" type="password" placeholder="M·∫≠t kh·∫©u" class="w-full mb-6 bg-slate-800 border border-slate-600 rounded p-3">
                            <button onclick="handleRegister()" class="w-full bg-green-600 py-3 rounded font-bold mb-2">T·∫†O T√ÄI KHO·∫¢N</button>
                            <button onclick="gameState.view='login';render()" class="w-full text-slate-400 text-sm">Quay l·∫°i</button>
                        </div>
                    </div>
                `;
            }

            // --- VIEW: GAME / ADMIN ---
            else if (gameState.view === 'game') {
                const isAdmin = DB.isAdmin(gameState.user.name);
                
                html = `
                    <div class="min-h-screen bg-slate-900 pb-20">
                        <div class="sticky top-0 z-50 glass border-b border-slate-700 p-4">
                            <div class="max-w-4xl mx-auto flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center font-bold text-xl">
                                        ${gameState.user.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="font-bold text-lg">${gameState.user.name} ${isAdmin ? '<span class="text-yellow-400 text-xs bg-yellow-400/20 px-2 py-0.5 rounded ml-1">ADMIN</span>' : ''}</div>
                                        <div class="text-yellow-400 font-mono">üí∞ ${gameState.user.gold.toLocaleString()}</div>
                                    </div>
                                </div>
                                <button onclick="DB.logout(); location.reload()" class="bg-red-600/80 hover:bg-red-600 px-4 py-2 rounded text-sm font-bold">THO√ÅT</button>
                            </div>
                        </div>

                        <div class="max-w-4xl mx-auto p-4 space-y-6">
                            
                            <div class="bg-blue-900/30 border border-blue-500/50 rounded-xl p-6 relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-4 opacity-10 text-9xl">üíæ</div>
                                <h3 class="text-xl font-bold text-blue-300 mb-2">QU·∫¢N L√ù D·ªÆ LI·ªÜU (SAVE/LOAD)</h3>
                                <p class="text-sm text-slate-400 mb-4">ƒê·ªÉ Admin c·ªông ti·ªÅn, h√£y t·∫£i file n√†y xu·ªëng v√† g·ª≠i cho Admin. Sau khi Admin c·ªông xong, t·∫£i file m·ªõi l√™n.</p>
                                <div class="flex gap-4">
                                    <button onclick="DB.exportDatabase()" class="flex-1 bg-green-600 hover:bg-green-500 py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                                        ‚¨áÔ∏è T·∫¢I FILE V·ªÄ M√ÅY
                                    </button>
                                    <button onclick="DB.triggerImport()" class="flex-1 bg-yellow-600 hover:bg-yellow-500 py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                                        ‚¨ÜÔ∏è N·∫†P FILE M·ªöI
                                    </button>
                                </div>
                            </div>

                            ${isAdmin ? `
                                <div class="bg-red-900/20 border border-red-500/50 rounded-xl p-6">
                                    <h3 class="text-xl font-bold text-red-400 mb-4">üëë ADMIN PANEL - C·ªòNG TI·ªÄN</h3>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm text-slate-400 mb-1">Username c·∫ßn c·ªông (Ch√≠nh x√°c):</label>
                                            <input id="adminTargetUser" type="text" placeholder="Nh·∫≠p t√™n user..." class="w-full bg-slate-900 border border-red-500/50 rounded p-3 text-white">
                                        </div>
                                        <div>
                                            <label class="block text-sm text-slate-400 mb-1">S·ªë v√†ng:</label>
                                            <input id="adminAmount" type="number" placeholder="VD: 10000" class="w-full bg-slate-900 border border-red-500/50 rounded p-3 text-white">
                                        </div>
                                    </div>
                                    <button onclick="handleAdminAddGold()" class="w-full mt-4 bg-gradient-to-r from-red-600 to-orange-600 py-3 rounded-lg font-bold shadow-lg hover:scale-[1.02] transition-transform">
                                        üí∞ TH·ª∞C HI·ªÜN C·ªòNG TI·ªÄN
                                    </button>
                                    <div class="mt-4 p-3 bg-black/40 rounded text-xs text-slate-300">
                                        <p>‚ÑπÔ∏è <strong>L∆∞u √Ω quan tr·ªçng:</strong></p>
                                        <p>1. N·∫øu User t·∫°o nick tr√™n m√°y kh√°c, h·ªç ph·∫£i g·ª≠i file JSON cho b·∫°n.</p>
                                        <p>2. B·∫°n d√πng n√∫t "N·∫†P FILE M·ªöI" ·ªü tr√™n ƒë·ªÉ nh·∫≠p d·ªØ li·ªáu c·ªßa h·ªç v√†o.</p>
                                        <p>3. C·ªông ti·ªÅn xong, b·∫°n d√πng n√∫t "T·∫¢I FILE V·ªÄ M√ÅY" v√† g·ª≠i l·∫°i file ƒë√≥ cho h·ªç.</p>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                    <div class="text-slate-400 text-xs">S·ª©c m·∫°nh (ATK)</div>
                                    <div class="text-2xl font-bold">‚öîÔ∏è ${gameState.user.atk}</div>
                                </div>
                                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                    <div class="text-slate-400 text-xs">M√°u (HP)</div>
                                    <div class="text-2xl font-bold">‚ù§Ô∏è ${gameState.user.hp}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            root.innerHTML = html;
        }

        // INIT
        const savedUser = DB.getCurrentUser();
        if (savedUser) {
            gameState.user = savedUser;
            gameState.view = 'game';
        }
        render();
    </script>
</body>
</html>
